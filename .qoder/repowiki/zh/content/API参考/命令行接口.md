# 命令行接口

<cite>
**本文档中引用的文件**  
- [cli.py](file://rdagent/app/cli.py)
- [factor.py](file://rdagent/app/qlib_rd_loop/factor.py)
- [model.py](file://rdagent/app/qlib_rd_loop/model.py)
- [quant.py](file://rdagent/app/qlib_rd_loop/quant.py)
- [factor_from_report.py](file://rdagent/app/qlib_rd_loop/factor_from_report.py)
- [general_model.py](file://rdagent/app/general_model/general_model.py)
- [loop.py](file://rdagent/app/data_science/loop.py)
- [ui.py](file://rdagent/log/ui/app.py)
- [server_ui.py](file://rdagent/log/server/app.py)
- [ds_user_interact.py](file://rdagent/log/ui/ds_user_interact.py)
- [health_check.py](file://rdagent/app/utils/health_check.py)
- [info.py](file://rdagent/app/utils/info.py)
</cite>

## 目录
1. [核心命令](#核心命令)
2. [UI相关命令](#ui相关命令)
3. [工具命令](#工具命令)
4. [命令依赖关系与使用流程](#命令依赖关系与使用流程)
5. [环境配置与CLI行为](#环境配置与cli行为)

## 核心命令

### fin_factor 命令
`fin_factor` 命令用于启动金融科技因子的自动研发演化循环。该命令支持从指定路径恢复会话，并可控制运行步数和循环次数。

**语法格式**
```
rdagent fin_factor [OPTIONS]
```

**参数说明**
- `path`: 会话恢复路径，格式如 `$LOG_PATH/__session__/1/0_propose`
- `step_n`: 运行的步数，可选参数
- `loop_n`: 运行的循环次数，可选参数
- `all_duration`: 运行的总时长
- `checkout`: 是否清理后续会话日志的布尔值，默认为 True
- `checkout_path`: 指定新的会话保存路径

**默认值**
- `checkout`: True

**示例调用**
```bash
rdagent fin_factor --path $LOG_PATH/__session__/1/0_propose --step_n 1
```

**预期输出**
命令将启动因子研发循环，输出包括因子提取结果、运行日志和反馈信息。

**使用场景**
适用于需要自动化生成和优化金融因子的场景，特别是在量化交易策略开发中。

**Section sources**
- [factor.py](file://rdagent/app/qlib_rd_loop/factor.py#L45-L60)

### fin_model 命令
`fin_model` 命令用于启动金融科技模型的自动研发演化循环。与 `fin_factor` 类似，它也支持会话恢复和运行控制。

**语法格式**
```
rdagent fin_model [OPTIONS]
```

**参数说明**
- `path`: 会话恢复路径
- `step_n`: 运行的步数
- `loop_n`: 运行的循环次数
- `all_duration`: 运行的总时长
- `checkout`: 是否清理后续会话日志

**默认值**
- `checkout`: True

**示例调用**
```bash
rdagent fin_model --path $LOG_PATH/__session__/1/0_propose --step_n 1
```

**预期输出**
命令将启动模型研发循环，输出包括模型开发结果、运行日志和反馈信息。

**使用场景**
适用于需要自动化生成和优化金融模型的场景，如预测模型、风险模型等。

**Section sources**
- [model.py](file://rdagent/app/qlib_rd_loop/model.py#L25-L43)

### fin_quant 命令
`fin_quant` 命令用于启动金融科技因子与模型联合的自动研发演化循环。该命令结合了因子和模型的研发过程。

**语法格式**
```
rdagent fin_quant [OPTIONS]
```

**参数说明**
- `path`: 会话恢复路径
- `step_n`: 运行的步数
- `loop_n`: 运行的循环次数
- `all_duration`: 运行的总时长
- `checkout`: 是否清理后续会话日志

**默认值**
- `checkout`: True

**示例调用**
```bash
rdagent fin_quant --path $LOG_PATH/__session__/1/0_propose --step_n 1
```

**预期输出**
命令将启动因子与模型联合研发循环，输出包括联合研发结果、运行日志和反馈信息。

**使用场景**
适用于需要同时优化因子和模型的复杂量化交易策略开发场景。

**Section sources**
- [quant.py](file://rdagent/app/qlib_rd_loop/quant.py#L125-L143)

### fin_factor_report 命令
`fin_factor_report` 命令用于从金融报告中提取因子并进行实现。该命令可以从指定文件夹中的PDF报告中提取因子。

**语法格式**
```
rdagent fin_factor_report [OPTIONS]
```

**参数说明**
- `report_folder`: 包含金融报告PDF文件的文件夹路径
- `path`: 会话恢复路径
- `all_duration`: 运行的总时长
- `checkout`: 是否清理后续会话日志

**默认值**
- `checkout`: True

**示例调用**
```bash
rdagent fin_factor_report --report_folder=git_ignore_folder/reports
```

**预期输出**
命令将处理指定文件夹中的所有PDF报告，输出包括从报告中提取的因子、运行日志和反馈信息。

**使用场景**
适用于需要从金融研究报告中自动提取和实现因子的场景，如分析师报告、行业研究报告等。

**Section sources**
- [factor_from_report.py](file://rdagent/app/qlib_rd_loop/factor_from_report.py#L159-L177)

### general_model 命令
`general_model` 命令用于从论文或报告中自动实现模型。该命令可以处理PDF文件或在线论文链接。

**语法格式**
```
rdagent general_model [REPORT_URL]
```

**参数说明**
- `report_file_path`: 报告文件路径或在线论文URL

**示例调用**
```bash
rdagent general_model "https://arxiv.org/pdf/2210.09789"
```

**预期输出**
命令将从指定的论文或报告中提取模型并实现，输出包括模型实现代码、运行日志和相关图像。

**使用场景**
适用于需要快速实现学术论文中提出的模型的场景，如机器学习模型、深度学习架构等。

**Section sources**
- [general_model.py](file://rdagent/app/general_model/general_model.py#L30-L45)

### data_science 命令
`data_science` 命令用于启动数据科学项目的自动研发循环。该命令支持指定竞赛名称和会话恢复。

**语法格式**
```
rdagent data_science [OPTIONS]
```

**参数说明**
- `path`: 会话恢复路径
- `checkout`: 是否清理后续会话日志
- `checkout_path`: 指定新的会话保存路径
- `step_n`: 运行的步数
- `loop_n`: 运行的循环次数
- `timeout`: 运行超时时间
- `competition`: 竞赛名称
- `replace_timer`: 是否替换计时器
- `exp_gen_cls`: 实验生成类

**默认值**
- `checkout`: True
- `competition`: "bms-molecular-translation"

**示例调用**
```bash
rdagent data_science --competition arf-12-hours-prediction-task
```

**预期输出**
命令将启动数据科学项目研发循环，输出包括项目开发结果、运行日志和反馈信息。

**使用场景**
适用于参加Kaggle等数据科学竞赛的自动化开发场景。

**Section sources**
- [loop.py](file://rdagent/app/data_science/loop.py#L50-L80)

## UI相关命令

### ui 命令
`ui` 命令用于启动Web应用程序以显示日志跟踪信息。该命令支持多种启动参数。

**语法格式**
```
rdagent ui [OPTIONS]
```

**参数说明**
- `port`: 服务器端口，默认为 19899
- `log_dir`: 日志目录路径
- `debug`: 是否启用调试模式
- `data_science`: 是否为数据科学应用

**默认值**
- `port`: 19899
- `debug`: False
- `data_science`: False

**示例调用**
```bash
rdagent ui --port 8080 --log_dir ./logs --debug
```

**访问方式**
通过浏览器访问 `http://localhost:19899`（或指定的端口）来查看Web界面。

**使用场景**
适用于需要可视化查看研发过程日志和跟踪信息的场景。

**Section sources**
- [cli.py](file://rdagent/app/cli.py#L15-L37)

### server_ui 命令
`server_ui` 命令用于启动实时显示日志跟踪的Web应用程序。

**语法格式**
```
rdagent server_ui [OPTIONS]
```

**参数说明**
- `port`: 服务器端口，默认为 19899

**默认值**
- `port`: 19899

**示例调用**
```bash
rdagent server_ui --port 8080
```

**访问方式**
通过浏览器访问 `http://localhost:19899`（或指定的端口）来查看实时Web界面。

**使用场景**
适用于需要实时监控研发过程的场景。

**Section sources**
- [cli.py](file://rdagent/app/cli.py#L40-L45)

### ds_user_interact 命令
`ds_user_interact` 命令用于启动数据科学用户交互的Web应用程序。

**语法格式**
```
rdagent ds_user_interact [OPTIONS]
```

**参数说明**
- `port`: 服务器端口，默认为 19900

**默认值**
- `port`: 19900

**示例调用**
```bash
rdagent ds_user_interact --port 8081
```

**访问方式**
通过浏览器访问 `http://localhost:19900`（或指定的端口）来查看用户交互界面。

**使用场景**
适用于需要与数据科学研发过程进行交互的场景，如提供用户反馈、调整假设等。

**Section sources**
- [cli.py](file://rdagent/app/cli.py#L47-L52)

## 工具命令

### health_check 命令
`health_check` 命令用于运行RD-Agent的健康检查，验证系统配置是否正确。

**语法格式**
```
rdagent health_check [OPTIONS]
```

**参数说明**
- `--check-env/--no-check-env (-e/-E)`: 是否检查API密钥和模型配置
- `--check-docker/--no-check-docker (-d/-D)`: 是否检查Docker是否安装和运行
- `--check-ports/--no-check-ports (-p/-P)`: 是否检查默认端口是否被占用

**默认值**
- `check_env`: True
- `check_docker`: True
- `check_ports`: True

**示例调用**
```bash
rdagent health_check --check-env --check-docker --check-ports
```

**预期输出**
命令将输出系统健康检查结果，包括Docker状态、端口占用情况和API配置验证结果。

**诊断功能**
- 检查Docker是否正常运行
- 检查默认端口19899是否被占用
- 验证API密钥和模型配置是否正确
- 测试聊天和嵌入模型的功能

**Section sources**
- [health_check.py](file://rdagent/app/utils/health_check.py#L145-L170)

### collect_info 命令
`collect_info` 命令用于收集系统和已安装包的信息。

**语法格式**
```
rdagent collect_info
```

**参数说明**
无

**示例调用**
```bash
rdagent collect_info
```

**预期输出**
命令将输出以下信息：
- 系统相关信息（操作系统、处理器架构等）
- Python版本信息
- 最近运行的Docker容器信息
- RD-Agent版本信息
- 依赖包版本列表

**诊断功能**
- 收集系统环境信息用于故障排查
- 验证RD-Agent及其依赖包的安装情况
- 提供详细的软件版本信息

**Section sources**
- [info.py](file://rdagent/app/utils/info.py#L70-L85)

## 命令依赖关系与使用流程

### 命令依赖关系
各命令之间存在一定的依赖关系，主要体现在功能层级和数据流上：

- `fin_factor`、`fin_model` 和 `fin_quant` 共享相同的底层研发框架，但针对不同的研发目标
- `fin_factor_report` 依赖于 `fin_factor` 的核心功能，但在输入源上专门处理金融报告
- `general_model` 与其他命令相对独立，专注于从学术文献中提取模型
- `data_science` 命令具有最复杂的依赖关系，整合了多种数据科学研发模式
- 所有UI命令都依赖于核心研发命令生成的日志数据
- 工具命令 `health_check` 和 `collect_info` 可以独立运行，用于系统诊断

### 典型使用流程
以下是几个典型的命令使用流程：

#### 金融因子研发流程
1. 运行 `health_check` 确保系统环境正常
2. 使用 `fin_factor` 启动因子研发循环
3. 通过 `ui` 命令查看研发过程和结果
4. 根据需要使用 `collect_info` 收集系统信息

#### 金融报告因子提取流程
1. 准备金融报告PDF文件到指定文件夹
2. 运行 `fin_factor_report --report_folder=<folder_path>` 提取因子
3. 使用 `server_ui` 实时监控提取过程
4. 通过 `collect_info` 记录本次运行的环境信息

#### 数据科学竞赛自动化流程
1. 配置竞赛相关环境变量
2. 运行 `data_science --competition <competition_name>` 启动自动化研发
3. 使用 `ds_user_interact` 进行必要的用户交互
4. 通过 `ui` 查看详细的研发日志和结果

#### 模型实现与验证流程
1. 使用 `general_model <paper_url>` 从论文中实现模型
2. 运行 `health_check` 确保API配置正确
3. 通过 `ui` 查看模型实现过程和结果
4. 使用 `collect_info` 记录实现环境的详细信息

## 环境配置与CLI行为

### 环境变量配置
CLI行为受多个环境变量的影响，主要通过 `.env` 文件进行配置：

- `BACKEND`: 指定后端实现，如 `rdagent.oai.backend.LiteLLMAPIBackend`
- `DEEPSEEK_API_KEY` 或 `OPENAI_API_KEY`: LLM服务的API密钥
- `CHAT_MODEL`: 聊天模型名称
- `EMBEDDING_MODEL`: 嵌入模型名称
- `LOG_TRACE_PATH`: 日志跟踪路径
- `LOG_UI_SERVER_PORT`: UI服务器端口
- `DS_LOCAL_DATA_PATH`: 本地数据路径
- `DS_CODER_ON_WHOLE_PIPELINE`: 是否对整个管道进行编码
- `DS_IF_USING_MLE_DATA`: 是否使用MLE数据
- `DS_SAMPLE_DATA_BY_LLM`: 是否由LLM采样数据
- `DS_SCEN`: 数据科学场景类

### 配置文件加载机制
系统使用多种配置文件来控制CLI行为：

- `.env` 文件：存储环境变量，通过 `dotenv` 库加载
- `pyproject.toml`: 项目配置文件，包含版本和依赖信息
- `prompts.yaml`: 存储各种提示模板，用于指导LLM生成内容
- `conf.py` 文件：在各个模块中存储特定配置，如 `FACTOR_PROP_SETTING`、`MODEL_PROP_SETTING` 等

### 环境配置对CLI行为的影响
环境配置直接影响CLI命令的行为和输出：

- API密钥配置决定了能否成功调用LLM服务
- 后端配置影响LLM调用的方式和性能
- 数据路径配置决定了命令能否找到所需的输入数据
- 场景配置决定了研发流程的具体实现方式
- 日志路径配置影响日志的存储位置和UI的访问

正确的环境配置是确保CLI命令正常运行的关键，建议在运行任何命令前先使用 `health_check` 验证配置的正确性。

**Section sources**
- [cli.py](file://rdagent/app/cli.py#L1-L87)
- [health_check.py](file://rdagent/app/utils/health_check.py#L1-L170)
- [info.py](file://rdagent/app/utils/info.py#L1-L86)