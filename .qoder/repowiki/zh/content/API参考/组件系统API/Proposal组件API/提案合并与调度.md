# 提案合并与调度系统技术文档

<cite>
**本文档引用的文件**
- [merge.py](file://rdagent/scenarios/data_science/proposal/exp_gen/merge.py)
- [merge.yaml](file://rdagent/scenarios/data_science/proposal/exp_gen/merge.yaml)
- [trace_scheduler.py](file://rdagent/scenarios/data_science/proposal/exp_gen/trace_scheduler.py)
- [base.py](file://rdagent/scenarios/data_science/proposal/exp_gen/base.py)
- [utils.py](file://rdagent/scenarios/data_science/proposal/exp_gen/utils.py)
- [naive.py](file://rdagent/scenarios/data_science/proposal/exp_gen/naive.py)
- [conf.py](file://rdagent/app/data_science/conf.py)
- [README.md](file://rdagent/scenarios/data_science/proposal/exp_gen/README.md)
</cite>

## 目录
1. [引言](#引言)
2. [系统架构概览](#系统架构概览)
3. [提案融合算法](#提案融合算法)
4. [执行调度器](#执行调度器)
5. [配置参数与调优](#配置参数与调优)
6. [时序流程分析](#时序流程分析)
7. [冲突解决与资源管理](#冲突解决与资源管理)
8. [性能优化策略](#性能优化策略)
9. [故障排除指南](#故障排除指南)
10. [总结](#总结)

## 引言

RD-Agent的提案合并与调度系统是一个复杂而精密的多智能体优化框架，专门设计用于在数据科学竞赛场景中自动优化解决方案。该系统通过融合多个独立探索轨迹中的优秀解决方案，实现了基于反馈闭环的动态优先级调整和智能调度决策。

系统的核心创新在于：
- 基于相似度的聚类合并算法
- 多维度优先级加权整合策略
- 智能执行队列管理系统
- 动态时间窗口的合并触发机制

## 系统架构概览

提案合并与调度系统采用分层架构设计，包含以下核心组件：

```mermaid
graph TB
subgraph "提案生成层"
MG[MergeExpGen] --> ME[ExpGen2Hypothesis]
ME --> MT[ExpGen2TraceAndMerge]
MT --> MV[ExpGen2TraceAndMergeV2]
MV --> M3[ExpGen2TraceAndMergeV3]
end
subgraph "调度管理层"
TS[TraceScheduler基类] --> RR[RoundRobinScheduler]
TS --> PS[ProbabilisticScheduler]
PS --> TL[TraceLengthScheduler]
PS --> SB[SOTABasedScheduler]
PS --> MS[MCTSScheduler]
PS --> RS[RandomScheduler]
end
subgraph "支持服务层"
DT[DSTrace] --> WS[工作空间管理]
DT --> FB[反馈处理]
DT --> HP[历史记录]
UT[Utils工具集] --> CS[CodingSketch]
UT --> CM[组件元数据]
end
MG --> DT
ME --> DT
MT --> DT
MV --> DT
M3 --> DT
TS --> DT
```

**图表来源**
- [merge.py](file://rdagent/scenarios/data_science/proposal/exp_gen/merge.py#L1-L448)
- [trace_scheduler.py](file://rdagent/scenarios/data_science/proposal/exp_gen/trace_scheduler.py#L1-L444)
- [base.py](file://rdagent/scenarios/data_science/proposal/exp_gen/base.py#L1-L349)

**章节来源**
- [merge.py](file://rdagent/scenarios/data_science/proposal/exp_gen/merge.py#L1-L50)
- [trace_scheduler.py](file://rdagent/scenarios/data_science/proposal/exp_gen/trace_scheduler.py#L1-L50)

## 提案融合算法

### 核心融合策略

提案融合算法是系统的核心，负责将多个独立轨迹中的优秀解决方案进行智能整合。主要包含以下几种融合模式：

#### 1. 基础合并策略（MergeExpGen）

基础合并策略通过比较当前最优解和待合并解之间的差异，生成融合任务：

```mermaid
flowchart TD
Start([开始融合过程]) --> GetLeaves[获取所有叶子节点]
GetLeaves --> SelectPair[选择最优解对]
SelectPair --> CompareFB[比较反馈信息]
CompareFB --> GenDesc[生成描述文本]
GenDesc --> CreateTask[创建融合任务]
CreateTask --> InjectCode[注入代码片段]
InjectCode --> End([返回实验对象])
CompareFB --> HasSuccessFB{是否有成功反馈?}
HasSuccessFB --> |是| SuccessPath[成功路径描述]
HasSuccessFB --> |否| FeedbackPath[反馈路径描述]
SuccessPath --> CreateTask
FeedbackPath --> CreateTask
```

**图表来源**
- [merge.py](file://rdagent/scenarios/data_science/proposal/exp_gen/merge.py#L20-L80)

#### 2. 智能假设生成（ExpGen2Hypothesis）

智能假设生成模块通过LLM分析多个轨迹的历史反馈，提出可测试的优化假设：

| 组件类型 | 评估维度 | 权重分配 | 阈值标准 |
|---------|---------|---------|---------|
| Problem-Hypothesis Alignment | 问题-假设匹配度 | 25% | ≥7/10 |
| Expected Impact | 预期改进幅度 | 20% | ≥6/10 |
| Novelty | 创新程度 | 15% | ≥5/10 |
| Feasibility | 实现难度 | 20% | ≥6/10 |
| Risk-Reward Balance | 探索-利用平衡 | 20% | ≥7/10 |

#### 3. 多轨迹融合（MergeExpGen_MultiTrace）

多轨迹融合支持同时合并多个不同轨迹的解决方案：

```mermaid
sequenceDiagram
participant C as 合并控制器
participant T1 as 轨迹1
participant T2 as 轨迹2
participant T3 as 轨迹3
participant M as 融合引擎
C->>T1 : 获取最优解
C->>T2 : 获取最优解
C->>T3 : 获取最优解
T1-->>C : 解决方案1
T2-->>C : 解决方案2
T3-->>C : 解决方案3
C->>M : 执行多轨迹融合
M->>M : 分析各轨迹特征
M->>M : 识别共同优势
M->>M : 检测潜在冲突
M-->>C : 融合结果
C->>C : 生成最终实验
```

**图表来源**
- [merge.py](file://rdagent/scenarios/data_science/proposal/exp_gen/merge.py#L280-L350)

**章节来源**
- [merge.py](file://rdagent/scenarios/data_science/proposal/exp_gen/merge.py#L20-L150)
- [merge.yaml](file://rdagent/scenarios/data_science/proposal/exp_gen/merge.yaml#L1-L122)

## 执行调度器

### 调度器架构设计

执行调度器采用策略模式设计，支持多种调度策略的动态切换：

```mermaid
classDiagram
class TraceScheduler {
<<abstract>>
+next(trace) tuple
+reset() void
}
class BaseScheduler {
-rec_commit_idx : int
-uncommited_rec_status : dict
+next(trace) tuple
+process_uncommitted_nodes(trace) void
+select(trace) tuple
+reset() void
}
class RoundRobinScheduler {
-max_trace_num : int
-_last_selected_leaf_id : int
+select(trace) tuple
}
class ProbabilisticScheduler {
-max_trace_num : int
-temperature : float
+calculate_potential(trace, leaf_id) float
+_softmax_probabilities(potentials) list
+select(trace) tuple
}
class TraceLengthScheduler {
-inverse : bool
+calculate_potential(trace, leaf_id) float
}
class SOTABasedScheduler {
-inverse : bool
+calculate_potential(trace, leaf_id) float
}
class MCTSScheduler {
-c_puct : float
-node_visit_count : dict
-node_value_sum : dict
-node_prior : dict
-global_visit_count : int
+_get_q(node_id) float
+_get_u(node_id) float
+observe_feedback(trace, new_idx) void
+reset() void
+process_uncommitted_nodes(trace) void
}
TraceScheduler <|-- BaseScheduler
BaseScheduler <|-- RoundRobinScheduler
BaseScheduler <|-- ProbabilisticScheduler
ProbabilisticScheduler <|-- TraceLengthScheduler
ProbabilisticScheduler <|-- SOTABasedScheduler
ProbabilisticScheduler <|-- RandomScheduler
ProbabilisticScheduler <|-- MCTSScheduler
```

**图表来源**
- [trace_scheduler.py](file://rdagent/scenarios/data_science/proposal/exp_gen/trace_scheduler.py#L15-L100)

### 动态优先级调整机制

#### MCTS风格调度器（MCTSScheduler）

MCTS调度器实现了PUCT（Posterior Upper Confidence bounds applied to Trees）算法的核心思想：

**PUCT公式：**
```
U(s,a) = Q(s,a) + c_puct × P(s,a) × √(N(s)) / (1 + N(s,a))
```

其中：
- Q(s,a)：平均奖励值（访问次数加权）
- P(s,a)：先验概率（来自潜在函数）
- N(s)：节点总访问次数
- N(s,a)：动作a的访问次数
- c_puct：探索常数

```mermaid
flowchart TD
Start([开始调度]) --> CheckTraces{检查轨迹数量}
CheckTraces --> |未达到目标| NewTrace[启动新轨迹]
CheckTraces --> |已达到目标| CalcPotentials[计算潜在分数]
CalcPotentials --> Softmax[Softmax归一化]
Softmax --> Sample[按概率采样]
Sample --> SelectLeaf[选择叶子节点]
SelectLeaf --> UpdateStats[更新统计信息]
UpdateStats --> ObserveFeedback[观察反馈]
ObserveFeedback --> UpdateQ[更新Q值]
UpdateQ --> UpdateVisits[更新访问计数]
UpdateVisits --> End([完成调度])
NewTrace --> End
```

**图表来源**
- [trace_scheduler.py](file://rdagent/scenarios/data_science/proposal/exp_gen/trace_scheduler.py#L335-L444)

#### 时间窗口调度策略

系统支持基于时间窗口的智能调度决策：

| 时间阶段 | 调度策略 | 合并触发条件 | 超时设置 |
|---------|---------|-------------|---------|
| 初期探索 | RoundRobin | ≤ max_trace_num | 1小时 |
| 中期优化 | Probabilistic | remain_time ≥ merge_hours | 2小时 |
| 最终融合 | MCTS | remain_time < merge_hours | 4小时 |

**章节来源**
- [trace_scheduler.py](file://rdagent/scenarios/data_science/proposal/exp_gen/trace_scheduler.py#L15-L200)
- [conf.py](file://rdagent/app/data_science/conf.py#L100-L150)

## 配置参数与调优

### 核心配置参数

系统提供了丰富的配置参数来控制合并与调度行为：

#### 合并相关配置

| 参数名 | 类型 | 默认值 | 描述 | 调优建议 |
|-------|------|-------|------|---------|
| `merge_hours` | float | 0 | 触发合并的时间阈值（小时） | 根据竞赛时长设置，通常为总时长的70-80% |
| `ratio_merge_or_ensemble` | int | 70 | 合并与集成的比例阈值 | 平衡探索与利用，建议70-80% |
| `max_sota_retrieved_num` | int | 10 | 单次检索的最大SOTA实验数 | 避免超出LLM上下文窗口，建议10-20 |
| `enable_multi_version_exp_gen` | bool | False | 启用多版本实验生成器 | 大型竞赛推荐启用 |

#### 调度器配置

| 参数名 | 类型 | 默认值 | 描述 | 调优建议 |
|-------|------|-------|------|---------|
| `max_trace_num` | int | 1 | 最大并行轨迹数 | 小竞赛：1-2，中等竞赛：3-5，大型竞赛：5-10 |
| `scheduler_temperature` | float | 1.0 | 调度器温度参数 | 高温度促进探索，低温度促进利用 |
| `scheduler_c_puct` | float | 1.0 | MCTS探索常数 | 0.5-2.0，根据竞赛稳定性调整 |
| `enable_score_reward` | bool | False | 启用分数奖励机制 | 推荐启用，提高调度质量 |

#### 性能调优参数

```mermaid
graph LR
subgraph "内存优化"
A[缓存策略] --> B[结果缓存]
A --> C[中间状态缓存]
end
subgraph "计算优化"
D[并行处理] --> E[异步调度]
D --> F[批量操作]
end
subgraph "网络优化"
G[连接池] --> H[超时控制]
G --> I[重试机制]
end
B --> J[性能提升]
C --> J
E --> J
F --> J
H --> J
I --> J
```

**图表来源**
- [conf.py](file://rdagent/app/data_science/conf.py#L150-L200)

**章节来源**
- [conf.py](file://rdagent/app/data_science/conf.py#L1-L200)
- [merge.yaml](file://rdagent/scenarios/data_science/proposal/exp_gen/merge.yaml#L1-L122)

## 时序流程分析

### 完整执行流程

从提案生成到最终提交的完整时序流程：

```mermaid
sequenceDiagram
participant U as 用户/系统
participant R as Router
participant MG as MergeGenerator
participant TS as TraceScheduler
participant E as Executor
participant L as Logger
U->>R : 启动优化循环
R->>TS : 初始化调度器
TS->>TS : 设置初始状态
loop 优化循环
TS->>TS : 检查剩余时间
alt 剩余时间充足
TS->>MG : 创建新轨迹
MG->>MG : 生成初始实验
MG-->>TS : 返回实验对象
else 剩余时间不足
TS->>MG : 触发合并阶段
MG->>MG : 收集所有轨迹
MG->>MG : 执行融合算法
MG-->>TS : 返回融合实验
end
TS->>E : 调度执行
E->>E : 执行实验
E->>L : 记录结果
L-->>E : 确认记录
E-->>TS : 返回反馈
TS->>TS : 更新调度策略
TS->>TS : 评估轨迹质量
end
R-->>U : 返回最佳解决方案
```

**图表来源**
- [merge.py](file://rdagent/scenarios/data_science/proposal/exp_gen/merge.py#L200-L300)
- [trace_scheduler.py](file://rdagent/scenarios/data_science/proposal/exp_gen/trace_scheduler.py#L50-L150)

### 关键决策点

#### 1. 合并触发时机判断

```mermaid
flowchart TD
Start([开始检查]) --> CheckTime{检查剩余时间}
CheckTime --> |≥ merge_hours| Continue[继续探索]
CheckTime --> |< merge_hours| CheckTraces{检查轨迹数量}
CheckTraces --> |< 2| Continue
CheckTraces --> |≥ 2| TriggerMerge[触发合并]
TriggerMerge --> SelectBest[选择最优轨迹]
SelectBest --> CompareScores[比较得分]
CompareScores --> GenerateHypothesis[生成融合假设]
GenerateHypothesis --> CreateExperiment[创建融合实验]
Continue --> NextIteration[下一轮迭代]
CreateExperiment --> NextIteration
NextIteration --> Start
```

**图表来源**
- [merge.py](file://rdagent/scenarios/data_science/proposal/exp_gen/merge.py#L220-L280)

#### 2. 调度策略切换

系统根据优化阶段自动切换调度策略：

| 阶段 | 时间范围 | 主要策略 | 切换条件 |
|------|---------|---------|---------|
| 初期 | 0-20% | RoundRobin | 达到最大轨迹数 |
| 探索 | 20-60% | Probabilistic | 剩余时间充足 |
| 优化 | 60-80% | MCTS | 剩余时间不足 |
| 融合 | 80-100% | MCTS+启发式 | 触发合并条件 |

**章节来源**
- [merge.py](file://rdagent/scenarios/data_science/proposal/exp_gen/merge.py#L200-L448)
- [trace_scheduler.py](file://rdagent/scenarios/data_science/proposal/exp_gen/trace_scheduler.py#L335-L444)

## 冲突解决与资源管理

### 提案冲突检测

系统实现了多层次的冲突检测机制：

#### 1. 轨迹冲突识别

```mermaid
flowchart TD
A[轨迹分析] --> B{是否存在重复组件?}
B --> |是| C[冲突检测]
B --> |否| D[兼容性验证]
C --> E{冲突类型}
E --> |数据冲突| F[数据预处理策略]
E --> |模型冲突| G[模型组合策略]
E --> |特征冲突| H[特征工程策略]
F --> I[生成冲突报告]
G --> I
H --> I
I --> J[自动修复建议]
D --> K[直接合并]
J --> L[用户确认]
K --> M[执行合并]
L --> M
```

#### 2. 资源竞争解决

| 资源类型 | 竞争检测 | 解决策略 | 优先级规则 |
|---------|---------|---------|-----------|
| 计算资源 | GPU/CPU使用率监控 | 动态负载均衡 | 先到先得 |
| 存储空间 | 磁盘使用量跟踪 | 清理过期文件 | 最近最少使用 |
| 内存占用 | 内存使用率监控 | 压缩缓存数据 | 最大可用空间 |
| 网络带宽 | 网络流量监控 | 限流控制 | 关键任务优先 |

### 自动化冲突解决

系统提供多种自动化冲突解决策略：

```mermaid
graph TB
subgraph "冲突类型"
A[数据冲突] --> A1[数据预处理去重]
A --> A2[特征选择优化]
B[模型冲突] --> B1[模型集成策略]
B --> B2[超参数调优]
C[资源冲突] --> C1[资源分配算法]
C --> C2[任务优先级排序]
end
subgraph "解决策略"
D[启发式方法] --> E[经验规则应用]
F[机器学习方法] --> G[预测模型训练]
H[博弈论方法] --> I[纳什均衡求解]
end
A1 --> D
A2 --> F
B1 --> H
B2 --> D
C1 --> F
C2 --> H
```

**章节来源**
- [base.py](file://rdagent/scenarios/data_science/proposal/exp_gen/base.py#L100-L200)
- [utils.py](file://rdagent/scenarios/data_science/proposal/exp_gen/utils.py#L1-L106)

## 性能优化策略

### 计算性能优化

#### 1. 并行化策略

系统采用多层次并行化策略：

```mermaid
graph TB
subgraph "任务级并行"
A[轨迹并行] --> A1[独立轨迹执行]
A --> A2[异步结果收集]
end
subgraph "组件级并行"
B[组件并行] --> B1[特征工程并行]
B --> B2[模型训练并行]
B --> B3[集成策略并行]
end
subgraph "数据级并行"
C[数据并行] --> C1[数据分片处理]
C --> C2[分布式存储]
C --> C3[缓存共享]
end
A1 --> D[性能提升]
A2 --> D
B1 --> D
B2 --> D
B3 --> D
C1 --> D
C2 --> D
C3 --> D
```

#### 2. 缓存优化策略

| 缓存层级 | 缓存内容 | 生命周期 | 清理策略 |
|---------|---------|---------|---------|
| L1缓存 | 频繁访问的实验结果 | 会话期间 | LRU淘汰 |
| L2缓存 | 中等频率的中间结果 | 日周期 | 基于访问频率 |
| L3缓存 | 历史实验数据 | 永久保存 | 基于重要性评分 |
| 磁盘缓存 | 大型数据集副本 | 可配置 | 基于存储空间 |

### 内存管理优化

#### 内存使用监控

```mermaid
flowchart TD
A[内存监控启动] --> B[实时监控]
B --> C{内存使用率}
C --> |< 70%| D[正常运行]
C --> |70-85%| E[警告级别]
C --> |> 85%| F[紧急处理]
E --> G[清理临时文件]
F --> H[强制垃圾回收]
H --> I[压缩缓存数据]
I --> J[释放非关键资源]
G --> K[重新监控]
D --> K
J --> K
K --> B
```

**章节来源**
- [trace_scheduler.py](file://rdagent/scenarios/data_science/proposal/exp_gen/trace_scheduler.py#L350-L444)
- [utils.py](file://rdagent/scenarios/data_science/proposal/exp_gen/utils.py#L80-L106)

## 故障排除指南

### 常见问题诊断

#### 1. 合并失败问题

**症状**：融合实验无法正常执行
**可能原因**：
- 轨迹间存在严重冲突
- LLM上下文窗口溢出
- 资源限制导致超时

**解决方案**：
```mermaid
flowchart TD
A[合并失败] --> B{错误类型}
B --> |冲突错误| C[分析冲突类型]
B --> |上下文错误| D[减少输入长度]
B --> |资源错误| E[增加资源限制]
C --> F[应用冲突解决策略]
D --> G[分块处理输入]
E --> H[扩展资源配置]
F --> I[重新尝试合并]
G --> I
H --> I
I --> J{是否成功?}
J --> |是| K[完成合并]
J --> |否| L[降级处理策略]
L --> M[手动干预]
```

#### 2. 调度器异常

**症状**：调度器无法正常选择轨迹
**诊断步骤**：
1. 检查轨迹状态完整性
2. 验证调度器配置参数
3. 分析潜在函数计算结果
4. 检查并发访问冲突

#### 3. 性能问题排查

| 问题类型 | 检查项目 | 优化措施 | 预期效果 |
|---------|---------|---------|---------|
| 内存泄漏 | 对象引用追踪 | 强制垃圾回收 | 内存使用稳定 |
| CPU瓶颈 | 进程CPU使用率 | 任务并行化 | 处理速度提升 |
| I/O阻塞 | 文件读写性能 | 异步I/O操作 | 响应时间改善 |
| 网络延迟 | API调用响应时间 | 连接池优化 | 网络效率提升 |

### 监控与告警

系统提供全面的监控和告警机制：

```mermaid
graph TB
subgraph "监控指标"
A[系统资源] --> A1[CPU使用率]
A --> A2[内存使用率]
A --> A3[磁盘空间]
A --> A4[网络带宽]
B[业务指标] --> B1[实验成功率]
B --> B2[调度效率]
B --> B3[合并质量]
B --> B4[收敛速度]
C[性能指标] --> C1[响应时间]
C --> C2[吞吐量]
C --> C3[错误率]
C --> C4[资源利用率]
end
subgraph "告警机制"
D[阈值监控] --> E[实时告警]
F[趋势分析] --> G[预防告警]
H[异常检测] --> I[紧急告警]
end
A1 --> D
A2 --> D
B1 --> F
B2 --> F
C1 --> H
C2 --> H
```

**章节来源**
- [base.py](file://rdagent/scenarios/data_science/proposal/exp_gen/base.py#L250-L349)
- [trace_scheduler.py](file://rdagent/scenarios/data_science/proposal/exp_gen/trace_scheduler.py#L400-L444)

## 总结

RD-Agent的提案合并与调度系统代表了自动化数据科学优化领域的前沿技术。通过精心设计的融合算法、智能调度策略和完善的冲突解决机制，该系统能够有效应对复杂的数据科学竞赛挑战。

### 核心优势

1. **智能化融合**：基于LLM的假设生成和多维度评估，确保融合质量
2. **动态调度**：自适应的调度策略切换，最大化利用有限时间
3. **鲁棒性强**：完善的冲突检测和自动解决机制
4. **可扩展性好**：模块化设计支持多种策略组合

### 应用前景

该系统不仅适用于Kaggle竞赛场景，还可扩展应用于：
- 企业级数据科学项目优化
- 自动化机器学习平台
- 科研项目的算法对比研究
- 工业界的大规模优化任务

随着人工智能技术的不断发展，提案合并与调度系统将在自动化优化领域发挥越来越重要的作用，为数据科学工作者提供强大的智能辅助工具。