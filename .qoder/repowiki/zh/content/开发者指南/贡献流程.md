# 贡献流程

<cite>
**本文档中引用的文件**  
- [CONTRIBUTING.md](file://CONTRIBUTING.md)
- [README.md](file://README.md)
- [Makefile](file://Makefile)
- [pyproject.toml](file://pyproject.toml)
- [requirements/lint.txt](file://requirements/lint.txt)
- [requirements/test.txt](file://requirements/test.txt)
</cite>

## 目录
1. [简介](#简介)
2. [贡献者工作流](#贡献者工作流)
3. [代码风格与格式化](#代码风格与格式化)
4. [本地验证：lint 与测试](#本地验证lint-与测试)
5. [提交信息规范](#提交信息规范)
6. [CI/CD 流程](#cicd-流程)
7. [典型贡献示例](#典型贡献示例)
8. [结论](#结论)

## 简介
RD-Agent 是一个致力于自动化数据驱动研发（R&D）过程的开源项目。该项目欢迎社区成员通过代码、文档、问题报告等多种形式进行贡献。本指南详细说明了向 RD-Agent 项目贡献代码的完整流程，包括从 Fork 仓库到提交 Pull Request 的每一步操作，以及项目所遵循的代码规范、本地验证方法、提交信息格式和 CI/CD 自动化流程。

**Section sources**
- [README.md](file://README.md#L1-L506)
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L1-L50)

## 贡献者工作流
向 RD-Agent 项目贡献代码的标准工作流遵循典型的 GitHub 开源协作模式。以下是详细的步骤说明：

1.  **Fork 仓库**：首先，在 GitHub 上找到 RD-Agent 的主仓库（`https://github.com/microsoft/RD-Agent`），点击右上角的 "Fork" 按钮，将仓库复制到你自己的 GitHub 账户下。

2.  **克隆仓库**：将你 Fork 的仓库克隆到本地开发环境。
    ```sh
    git clone https://github.com/your-username/RD-Agent.git
    cd RD-Agent
    ```

3.  **创建特性分支**：基于 `main` 分支创建一个新的特性分支，用于开发你的功能或修复。分支名称应具有描述性，例如 `feature/add-new-scenario` 或 `fix/bug-in-data-loader`。
    ```sh
    git checkout -b feature/your-feature-name
    ```

4.  **进行修改**：在本地分支上进行代码修改、添加新功能或修复 Bug。

5.  **提交更改**：使用符合规范的提交信息（详见下文）将更改提交到你的本地分支。
    ```sh
    git add .
    git commit -m "feat: add new data loader for scenario X"
    ```

6.  **推送更改**：将你的本地分支推送到你 Fork 的远程仓库。
    ```sh
    git push origin feature/your-feature-name
    ```

7.  **创建 Pull Request (PR)**：访问你 Fork 的仓库页面，GitHub 通常会提示你创建一个 Pull Request。点击 "Compare & pull request"，将你的分支与上游仓库的 `main` 分支进行比较，并创建 PR。在 PR 描述中清晰地说明你所做的更改、解决的问题或实现的功能。

8.  **等待 CI 检查**：一旦 PR 被创建，GitHub Actions 会自动触发 CI/CD 流程，运行代码检查和测试。你可以在 PR 页面看到这些检查的状态。

9.  **代码审查与迭代**：项目维护者会审查你的代码。根据反馈，你可能需要对代码进行修改。只需在本地分支上进行更改，然后再次 `git add`、`git commit` 和 `git push`，这些更新会自动同步到已有的 PR 中。

10. **合并**：当你的代码通过了所有 CI 检查并获得维护者的批准后，PR 将被合并到主仓库的 `main` 分支中。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L1-L50)

## 代码风格与格式化
RD-Agent 项目强制执行严格的代码风格规范，以确保代码库的一致性和可读性。项目主要依赖 `ruff` 和 `black` 两个工具来自动化代码格式化。

*   **`ruff`**：这是一个超快的 Python linter 和代码格式化工具，集成了 `flake8`、`isort` 等多个检查器的功能。它用于检查代码中的语法错误、未使用的变量、代码风格问题等。项目通过 `pyproject.toml` 文件中的 `[tool.ruff]` 部分进行配置，例如设置行长度为 120，并选择检查所有规则。
*   **`black`**：这是一个不妥协的 Python 代码格式化工具，被称为 "不妥协的代码格式化程序"。它会自动重新格式化你的代码，使其符合 PEP 8 规范，开发者无需再为代码风格争论。项目在 `Makefile` 中通过 `black` 目标调用此工具。

除了这两个核心工具，项目还使用了 `isort`（用于排序导入语句）和 `toml-sort`（用于排序 TOML 文件）。这些工具的配置都集成在 `pyproject.toml` 文件中，确保了配置的集中化管理。

**Section sources**
- [pyproject.toml](file://pyproject.toml#L1-L125)
- [Makefile](file://Makefile#L90-L129)
- [requirements/lint.txt](file://requirements/lint.txt#L1-L10)

## 本地验证：lint 与测试
在提交代码之前，强烈建议在本地运行验证命令，以提前发现并修复问题，避免 CI 流程失败。

*   **运行 `make lint`**：此命令会执行项目定义的所有代码检查。根据 `Makefile` 中的定义，`lint` 目标会依次运行 `mypy`（类型检查）、`ruff`（代码检查）、`isort`（导入排序）、`black`（代码格式化）和 `toml-sort`（TOML 文件排序）。
    ```sh
    make lint
    ```
    如果该命令报告错误，你需要根据提示修改代码，直到 `make lint` 能够无错误地通过。

*   **运行 `make test`**：此命令用于运行项目的单元测试。根据 `Makefile`，`test` 目标会先执行 `test-run`（使用 `coverage` 运行 `pytest`），然后生成测试覆盖率报告。项目要求测试覆盖率不低于 20%（尽管目标是 80%）。
    ```sh
    make test
    ```
    在进行功能开发或修复 Bug 时，应确保相关的测试用例通过，并尽可能为新代码添加测试。

**Section sources**
- [Makefile](file://Makefile#L90-L129)
- [requirements/test.txt](file://requirements/test.txt#L1-L4)

## 提交信息规范
RD-Agent 项目采用 **Conventional Commits** 规范来标准化提交信息的格式。这不仅使提交历史更加清晰易读，还便于自动生成变更日志（changelog）。

提交信息的结构如下：
```
<type>(<scope>): <subject>
<BLANK LINE>
<body>
<BLANK LINE>
<footer>
```

*   **`<type>`**：提交的类型，例如：
    *   `feat`：新增功能
    *   `fix`：修复 Bug
    *   `docs`：文档更新
    *   `style`：代码格式调整（不影响逻辑）
    *   `refactor`：代码重构
    *   `test`：增加或修改测试
    *   `chore`：构建过程或辅助工具的变动
*   **`<scope>`**：可选，指明本次更改影响的范围，例如 `core`、`components`、`app` 等。
*   **`<subject>`**：对本次更改的简洁描述，使用祈使句，首字母小写，不加句号。

例如：
```
feat(app): add new CLI command for health check
fix(core): resolve memory leak in experiment loop
docs: update installation guide for Linux
```

**Section sources**
- [Makefile](file://Makefile#L182-L203)

## CI/CD 流程
RD-Agent 项目通过 GitHub Actions 实现了自动化的 CI/CD 流程。当有新的 Pull Request 被创建或更新时，会自动触发一系列工作流。

根据 `README.md` 中的徽章，主要的 CI 工作流包括：
*   **CI 工作流** (`ci.yml`)：这是核心的持续集成流程，会自动运行 `make lint` 和 `make test`，确保代码质量和测试通过。
*   **CodeQL 分析**：进行安全扫描，检测代码中的潜在漏洞。
*   **Dependabot 更新**：自动检查并更新项目依赖项。
*   **PR 标题检查** (`pr.yml`)：验证 Pull Request 的标题是否符合 Conventional Commits 规范。
*   **发布工作流** (`release.yml`)：在创建新版本时，自动打包并发布到 PyPI。

CI/CD 流程是代码合并的必要条件。只有当所有 CI 检查都通过后，维护者才会考虑合并 PR。这保证了主分支代码的稳定性和可靠性。

**Section sources**
- [README.md](file://README.md#L1-L506)

## 典型贡献示例
以下是一个新贡献者为 RD-Agent 添加一个新功能的典型工作流示例：

1.  **准备环境**：
    ```bash
    # 创建并激活 Conda 环境
    conda create -n rdagent python=3.10
    conda activate rdagent

    # 安装开发依赖
    git clone https://github.com/your-username/RD-Agent.git
    cd RD-Agent
    make dev
    ```

2.  **开发功能**：
    ```bash
    # 创建特性分支
    git checkout -b feature/add-new-data-science-scenario

    # 编辑代码文件...
    # ... 实现新功能 ...
    ```

3.  **本地验证**：
    ```bash
    # 运行代码检查
    make lint

    # 运行测试
    make test

    # 如果有格式化错误，可以使用 make auto-lint 自动修复
    # make auto-lint
    ```

4.  **提交与推送**：
    ```bash
    git add .
    git commit -m "feat(scenarios): add new data science scenario for time series"
    git push origin feature/add-new-data-science-scenario
    ```

5.  **创建 PR**：在 GitHub 上创建 Pull Request，描述新功能，并等待 CI 检查和代码审查。

**Section sources**
- [README.md](file://README.md#L1-L506)
- [Makefile](file://Makefile#L1-L222)

## 结论
向 RD-Agent 项目贡献代码是一个结构化且自动化程度很高的过程。通过遵循 Fork-Branch-Commit-Push-PR 的工作流，遵守 Conventional Commits 提交规范，并利用 `make lint` 和 `make test` 在本地进行充分验证，你可以高效地为项目做出贡献。项目的 CI/CD 流程作为质量守门员，确保了代码库的稳定和健康。希望本指南能帮助新贡献者快速上手，共同推动 RD-Agent 项目的发展。