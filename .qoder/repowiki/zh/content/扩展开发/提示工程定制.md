# 提示工程定制

<cite>
**本文档中引用的文件**  
- [prompts.yaml](file://rdagent/app/CI/prompts.yaml)
- [llm_conf.py](file://rdagent/oai/llm_conf.py)
- [tpl.py](file://rdagent/utils/agent/tpl.py)
- [core/prompts.py](file://rdagent/core/prompts.py)
- [aerial-cactus-identification/README.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/README.md)
- [aerial-cactus-identification/spec/data_loader.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/spec/data_loader.md)
- [aerial-cactus-identification/spec/feature.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/spec/feature.md)
- [aerial-cactus-identification/spec/model.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/spec/model.md)
- [aerial-cactus-identification/spec/ensemble.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/spec/ensemble.md)
- [aerial-cactus-identification/spec/workflow.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/spec/workflow.md)
- [aerial-cactus-identification/main.py](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/main.py)
- [aerial-cactus-identification/load_data.py](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/load_data.py)
- [aerial-cactus-identification/feature.py](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/feature.py)
- [aerial-cactus-identification/model01.py](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/model01.py)
- [aerial-cactus-identification/ensemble.py](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/ensemble.py)
- [qlib_rd_loop/prompts.yaml](file://rdagent/app/qlib_rd_loop/prompts.yaml)
</cite>

## 目录
1. [引言](#引言)
2. [YAML提示文件结构与变量注入机制](#yaml提示文件结构与变量注入机制)
3. [领域特定提示词优化](#领域特定提示词优化)
4. [多语言支持与中文提示设计](#多语言支持与中文提示设计)
5. [aerial-cactus-identification实例分析](#aerial-cactus-identification实例分析)
6. [与llm_conf.py后端配置的协同调整](#与llm_confpy后端配置的协同调整)
7. [结论](#结论)

## 引言

本指南旨在为开发者提供全面的提示工程定制方案，以优化大型语言模型（LLM）的交互效果。通过深入分析RD-Agent框架中的提示系统，我们将探讨YAML格式提示文件的结构、变量注入机制、领域特定提示词的优化策略、多语言支持配置，以及如何通过具体实例实现从需求分析到提示迭代的完整优化流程。特别关注与`llm_conf.py`中后端配置的协同调整，确保提示工程与系统架构的无缝集成。

## YAML提示文件结构与变量注入机制

### 提示模板加载机制

RD-Agent使用`tpl.py`中的`RDAT`类实现提示模板的加载与渲染。该机制支持多种URI格式和加载优先级：

- **格式1**: `a.b.c:x.y.z` - 从`a/b/c.yaml`加载并提取`x.y.z`路径下的内容
- **格式2**: `.c:x.y.z` - 从调用者目录下的`c.yaml`加载并提取指定路径
- **格式3**: `a.b.c` (ftype="txt") - 直接加载`a/b/c.txt`的文本内容

加载优先级顺序为：
1. 以`.`开头的相对路径（最高优先级）
2. 当前目录下的模板文件
3. RD-Agent包目录下的默认模板

**Section sources**
- [tpl.py](file://rdagent/utils/agent/tpl.py#L41-L148)

### YAML文件结构

以`rdagent/app/CI/prompts.yaml`为例，提示文件采用扁平化的键值结构，每个键对应一个提示模板：

```yaml
generate_lint_command_template: |
  Please generate a command to lint or format a {language} repository.
  Here are some information about different linting tools ```{linting_tools}```
```

模板中使用`{variable}`语法进行变量注入，支持在渲染时动态替换。

**Section sources**
- [prompts.yaml](file://rdagent/app/CI/prompts.yaml#L0-L37)

### 变量注入与上下文渲染

`RDAT.r()`方法使用Jinja2模板引擎渲染提示内容，支持复杂的上下文注入：

```python
def r(self, **context: Any) -> str:
    rendered = (
        Environment(undefined=StrictUndefined, loader=FunctionLoader(load_content))
        .from_string(self.template)
        .render(**context)
        .strip("\n")
    )
```

该机制允许在提示中嵌套其他模板（通过`{% include %}`语法），实现模块化的提示设计。

**Section sources**
- [tpl.py](file://rdagent/utils/agent/tpl.py#L120-L147)

## 领域特定提示词优化

### 金融预测领域提示设计

在金融分析场景中，提示设计需要强调严谨的假设生成和风险评估。`qlib_rd_loop/prompts.yaml`中的提示模板展示了这一特点：

```yaml
hypothesis_generation:
  system: |-
    You are an expert in financial analysis. Your task is to generate a well-reasoned hypothesis based on the provided financial factors and report content.
    Please ensure your response is in JSON format as shown below:
    {
      "hypothesis": "A clear and concise hypothesis based on the provided information.",
      "reason": "A detailed explanation supporting the generated hypothesis.",
    }
```

该提示明确要求：
- 角色设定为"金融分析专家"
- 输出格式为结构化JSON
- 包含假设和理由两个关键部分

**Section sources**
- [qlib_rd_loop/prompts.yaml](file://rdagent/app/qlib_rd_loop/prompts.yaml#L0-L14)

### 医疗影像分析领域提示设计

虽然项目中未直接提供医疗影像分析的提示模板，但从`aerial-cactus-identification`实例可以推断出类似领域的设计原则。这类任务需要：
- 明确的数据输入输出格式规范
- 详细的特征工程要求
- 严格的模型工作流定义
- 精确的集成策略

这些要求通过`.md`规格文件而非YAML提示文件来定义，体现了不同领域采用不同提示形式的灵活性。

**Section sources**
- [aerial-cactus-identification/spec/data_loader.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/spec/data_loader.md#L0-L3)
- [aerial-cactus-identification/spec/feature.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/spec/feature.md#L0-L33)
- [aerial-cactus-identification/spec/model.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/spec/model.md#L0-L44)

## 多语言支持与中文提示设计

### 多语言配置基础

当前系统主要使用英文提示，但通过模板机制可以轻松实现多语言支持。实现方案包括：

1. **语言特定模板目录**：创建`prompts/zh-CN/`和`prompts/en-US/`等目录
2. **运行时语言选择**：根据配置加载相应语言的提示文件
3. **混合语言支持**：在单个模板中支持多语言内容

### 中文提示设计策略

设计高质量的中文提示需要考虑：
- **文化适应性**：避免直译，确保表达符合中文思维习惯
- **术语一致性**：建立统一的中文技术术语表
- **简洁性**：利用中文表达的简洁优势，避免冗长描述
- **结构清晰**：使用明确的分段和标点，提高可读性

例如，将英文提示转换为中文时：
```text
"Please generate a command to lint or format a {language} repository."
→
"请生成一个用于{language}代码库的格式化或检查命令。"
```

**Section sources**
- [tpl.py](file://rdagent/utils/agent/tpl.py#L41-L148)

## aerial-cactus-identification实例分析

### 项目概述

`aerial-cactus-identification`是一个Kaggle竞赛模板示例，展示了从需求分析到实现的完整流程。该项目通过一系列`.md`规格文件定义了各个组件的实现要求。

**Section sources**
- [aerial-cactus-identification/README.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/README.md)

### 需求分析到提示迭代流程

#### 1. 数据加载需求

`data_loader.md`定义了数据加载的基本要求：
- 实现数据加载函数
- 返回训练图像、标签、测试图像和测试ID

这相当于一个简单的提示，指导开发者实现特定功能。

**Section sources**
- [data_loader.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/spec/data_loader.md#L0-L3)

#### 2. 特征工程需求

`feature.md`提供了更详细的函数签名和文档字符串，相当于一个结构化提示：

```python
def feat_eng(X: np.ndarray, y: np.ndarray | None = None, X_fit: np.ndarray | None = None, y_fit: np.ndarray | None = None, param: object | None = None) -> tuple[np.ndarray, np.ndarray | None, object]:
    """
    Perform feature engineering on the input data.
    ...
    """
```

这种设计确保了实现的一致性和可预测性。

**Section sources**
- [feature.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/spec/feature.md#L0-L33)

#### 3. 模型工作流需求

`model.md`定义了复杂的模型工作流要求，包括：
- 处理训练、验证和测试数据
- 支持超参数配置
- 实现早停机制
- 返回验证和测试预测

这些要求构成了一个详细的"提示"，指导模型的实现。

**Section sources**
- [model.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/spec/model.md#L0-L44)

#### 4. 集成与决策需求

`ensemble.md`规定了集成策略：
- 使用简单平均法集成预测
- 将预测结果转换为最终格式

**Section sources**
- [ensemble.md](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/spec/ensemble.md#L0-L28)

### 完整实现流程

通过`main.py`将各个组件组合起来，形成完整的解决方案。这种分而治之的方法体现了提示工程的核心思想：将复杂任务分解为可管理的子任务，每个子任务都有明确的提示或规格。

**Section sources**
- [main.py](file://rdagent/scenarios/kaggle/tpl_ex/aerial-cactus-identification/main.py)

## 与llm_conf.py后端配置的协同调整

### LLM设置结构

`llm_conf.py`中的`LLMSettings`类定义了LLM交互的核心配置：

```python
class LLMSettings(ExtendedBaseSettings):
    backend: str = "rdagent.oai.backend.LiteLLMAPIBackend"
    chat_model: str = "gpt-4-turbo"
    embedding_model: str = "text-embedding-3-small"
    reasoning_effort: Literal["low", "medium", "high"] | None = None
    enable_response_schema: bool = True
    log_llm_chat_content: bool = True
    chat_temperature: float = 0.5
    chat_max_tokens: int | None = None
```

**Section sources**
- [llm_conf.py](file://rdagent/oai/llm_conf.py#L0-L40)

### 提示与配置的协同

提示工程需要与这些后端配置协同工作：

1. **模型选择**：根据`chat_model`选择合适的提示策略
   - GPT-4等高级模型支持复杂提示和结构化输出
   - 较小模型需要更简单、直接的提示

2. **响应格式**：利用`enable_response_schema`启用结构化输出
   - 当为`True`时，可以要求JSON格式响应
   - 提供明确的输出模板

3. **温度参数**：通过`chat_temperature`控制创造性
   - 低温度（0.2-0.5）：适合需要精确、确定性输出的任务
   - 高温度（0.7-1.0）：适合需要创造性和多样性的任务

4. **缓存策略**：`use_chat_cache`影响提示设计
   - 启用缓存时，提示应设计为幂等操作
   - 考虑缓存键的生成策略

### 动态配置映射

`chat_model_map`配置允许根据不同场景使用不同的模型参数：

```python
chat_model_map: dict[str, dict[str, str]] = {}
```

这支持基于标签的动态提示路由，例如：
- "medical"标签 → 使用医疗领域优化的模型和提示
- "finance"标签 → 使用金融领域优化的模型和提示

**Section sources**
- [llm_conf.py](file://rdagent/oai/llm_conf.py#L0-L132)

## 结论

本指南详细介绍了RD-Agent框架中的提示工程定制方法。通过分析YAML提示文件结构、变量注入机制、领域特定优化策略、多语言支持方案以及具体实例，我们展示了如何系统性地优化LLM交互效果。

关键要点包括：
- 使用分层的提示模板加载机制实现灵活的配置管理
- 针对不同领域（如金融预测、医疗影像分析）设计专门的提示策略
- 通过`.md`规格文件和YAML提示的组合实现复杂任务的分解
- 将提示工程与`llm_conf.py`中的后端配置协同调整，最大化系统性能

开发者应根据具体应用场景，结合这些原则和模式，创建高效、可靠的提示系统，从而充分发挥LLM的潜力。