# 场景与实验

<cite>
**本文档中引用的文件**
- [rdagent/core/scenario.py](file://rdagent/core/scenario.py)
- [rdagent/core/experiment.py](file://rdagent/core/experiment.py)
- [rdagent/scenarios/data_science/experiment/experiment.py](file://rdagent/scenarios/data_science/experiment/experiment.py)
- [rdagent/scenarios/data_science/scen/__init__.py](file://rdagent/scenarios/data_science/scen/__init__.py)
- [rdagent/scenarios/kaggle/experiment/scenario.py](file://rdagent/scenarios/kaggle/experiment/scenario.py)
- [rdagent/core/evolving_agent.py](file://rdagent/core/evolving_agent.py)
- [rdagent/components/coder/CoSTEER/evolvable_subjects.py](file://rdagent/components/coder/CoSTEER/evolvable_subjects.py)
- [rdagent/core/evolving_framework.py](file://rdagent/core/evolving_framework.py)
- [rdagent/scenarios/data_science/loop.py](file://rdagent/scenarios/data_science/loop.py)
- [rdagent/app/data_science/loop.py](file://rdagent/app/data_science/loop.py)
- [rdagent/scenarios/data_science/dev/runner.py](file://rdagent/scenarios/data_science/dev/runner.py)
- [rdagent/components/coder/data_science/share/ds_costeer.py](file://rdagent/components/coder/data_science/share/ds_costeer.py)
</cite>

## 目录
1. [引言](#引言)
2. [场景（Scenario）概念](#场景scenario概念)
3. [实验（Experiment）概念](#实验experiment概念)
4. [EvolvingItem与演化能力](#evolvingitem与演化能力)
5. [数据科学场景的具体实现](#数据科学场景的具体实现)
6. [组件协作关系](#组件协作关系)
7. [完整的执行流程](#完整的执行流程)
8. [总结](#总结)

## 引言

在RD-Agent框架中，场景（Scenario）和实验（Experiment）是两个核心概念，它们共同构成了系统应用边界和执行单元的基础架构。场景定义了特定领域的行为规范和环境约束，而实验则封装了具体的研发任务和执行过程。通过这种分层设计，RD-Agent能够灵活地适应不同的研究开发需求，同时保持代码结构的清晰性和可扩展性。

## 场景（Scenario）概念

### 基础抽象

场景（Scenario）是RD-Agent中定义特定领域行为的抽象基类，它为不同类型的场景提供了统一的接口规范。

```mermaid
classDiagram
class Scenario {
<<abstract>>
+background : str
+source_data : str
+rich_style_description : str
+experiment_setting : str
+get_source_data_desc(task) str
+get_scenario_all_desc(task, filtered_tag, simple_background) str
+get_runtime_environment() str
}
class DataScienceScen {
+competition : str
+metric_name : str
+task_type : str
+data_type : str
+metric_direction : bool
+timeout_increase_count : int
+real_debug_timeout() int
+real_full_timeout() int
+increase_timeout() void
}
class KGScenario {
+competition : str
+competition_type : str
+evaluation_metric_direction : bool
+action_counts : dict
+reward_estimates : dict
+interface(tag) str
+output_format(tag) str
+simulator(tag) str
}
Scenario <|-- DataScienceScen
Scenario <|-- KGScenario
```

**图表来源**
- [rdagent/core/scenario.py](file://rdagent/core/scenario.py#L6-L64)
- [rdagent/scenarios/data_science/scen/__init__.py](file://rdagent/scenarios/data_science/scen/__init__.py#L18-L289)
- [rdagent/scenarios/kaggle/experiment/scenario.py](file://rdagent/scenarios/kaggle/experiment/scenario.py#L25-L281)

### 核心属性和方法

场景类定义了以下关键属性和方法：

| 属性/方法 | 类型 | 描述 |
|-----------|------|------|
| `background` | property | 提供场景背景信息 |
| `source_data` | property | 数据源描述的便捷访问 |
| `rich_style_description` | property | 富文本格式的场景描述 |
| `get_source_data_desc()` | method | 根据具体任务获取数据源描述 |
| `get_scenario_all_desc()` | method | 组合所有描述信息 |
| `get_runtime_environment()` | method | 获取运行时环境信息 |

### 场景的职责

场景的主要职责包括：
- **环境定义**：提供特定领域的环境配置和约束条件
- **数据管理**：描述可用的数据源和数据格式
- **评估标准**：定义性能评估指标和方向
- **资源分配**：管理计算资源和时间限制

**章节来源**
- [rdagent/core/scenario.py](file://rdagent/core/scenario.py#L6-L64)

## 实验（Experiment）概念

### 实验基础架构

实验（Experiment）是RD-Agent中封装具体研发任务的核心类，它继承自抽象基类并提供了完整的生命周期管理。

```mermaid
classDiagram
class Experiment~T, WS, SW~ {
<<abstract>>
+sub_tasks : Sequence[T]
+sub_workspace_list : list[SW | None]
+experiment_workspace : WS | None
+hypothesis : Hypothesis | None
+based_experiments : Sequence[WS]
+prop_dev_feedback : Feedback | None
+running_info : RunningInfo
+sub_results : dict[str, float]
+local_selection : tuple[int, ...] | None
+plan : ExperimentPlan | None
+user_instructions : UserInstructions | None
+set_user_instructions(ui) void
+create_ws_ckp() void
+recover_ws_ckp() void
}
class DSExperiment {
+pending_tasks_list : list
+hypothesis_candidates : list | None
+format_check_result : object | None
+is_ready_to_run() bool
+set_local_selection(ls) void
}
class FBWorkspace {
+target_task : T | None
+feedback : F | None
+running_info : RunningInfo
+file_dict : dict[str, Any]
+workspace_path : Path
+ws_ckp : bytes | None
+change_summary : str | None
+execute(env, entry) str
+inject_files(**files) void
+create_ws_ckp() void
+recover_ws_ckp() void
}
Experiment <|-- DSExperiment
Experiment --> FBWorkspace : uses
```

**图表来源**
- [rdagent/core/experiment.py](file://rdagent/core/experiment.py#L383-L482)
- [rdagent/scenarios/data_science/experiment/experiment.py](file://rdagent/scenarios/data_science/experiment/experiment.py#L9-L43)

### 实验的关键特性

实验类具有以下核心特性：

| 特性 | 类型 | 描述 |
|------|------|------|
| **子任务管理** | `Sequence[Task]` | 管理实验分解后的子任务列表 |
| **工作空间** | `Workspace` | 存储任务实现的工作区 |
| **假设支持** | `Hypothesis` | 可选的假设驱动实验 |
| **反馈机制** | `Feedback` | 开发者反馈的传递 |
| **运行信息** | `RunningInfo` | 记录实验执行状态 |
| **检查点功能** | `create_ws_ckp()` | 工作区状态保存和恢复 |

### 工作区（Workspace）系统

工作区是实验的重要组成部分，提供了代码管理和执行环境：

```mermaid
flowchart TD
A[初始化工作区] --> B[准备环境]
B --> C[注入代码文件]
C --> D[执行代码]
D --> E{是否需要检查点?}
E --> |是| F[创建检查点]
E --> |否| G[清理工作区]
F --> H[恢复检查点]
H --> G
G --> I[实验完成]
```

**图表来源**
- [rdagent/core/experiment.py](file://rdagent/core/experiment.py#L130-L382)

**章节来源**
- [rdagent/core/experiment.py](file://rdagent/core/experiment.py#L383-L482)
- [rdagent/scenarios/data_science/experiment/experiment.py](file://rdagent/scenarios/data_science/experiment/experiment.py#L9-L43)

## EvolvingItem与演化能力

### 演化项目（EvolvingItem）

EvolvingItem是Experiment和EvolvableSubjects的多重继承类，为实验添加了演化能力。

```mermaid
classDiagram
class Experiment {
+sub_tasks : Sequence[Task]
+experiment_workspace : Workspace
+hypothesis : Hypothesis
+running_info : RunningInfo
}
class EvolvableSubjects {
+clone() EvolvableSubjects
}
class EvolvingItem {
+sub_gt_implementations : list[FBWorkspace]
+from_experiment(exp) EvolvingItem
}
Experiment <|-- EvolvingItem
EvolvableSubjects <|-- EvolvingItem
```

**图表来源**
- [rdagent/components/coder/CoSTEER/evolvable_subjects.py](file://rdagent/components/coder/CoSTEER/evolvable_subjects.py#L6-L32)

### 演化框架

演化框架提供了完整的演化策略和知识管理系统：

```mermaid
sequenceDiagram
participant EA as EvolvingAgent
participant ES as EvolvingStrategy
participant KB as KnowledgeBase
participant E as EvolvingItem
participant FE as FeedbackEvaluator
EA->>KB : 查询知识
KB-->>EA : 返回查询结果
EA->>ES : 执行演化策略
ES->>E : 创建新的演化项目
E-->>ES : 返回演化结果
ES-->>EA : 返回演化项目
EA->>FE : 评估反馈
FE-->>EA : 返回反馈结果
EA->>KB : 更新知识库
```

**图表来源**
- [rdagent/core/evolving_framework.py](file://rdagent/core/evolving_framework.py#L40-L127)
- [rdagent/core/evolving_agent.py](file://rdagent/core/evolving_agent.py#L50-L115)

**章节来源**
- [rdagent/components/coder/CoSTEER/evolvable_subjects.py](file://rdagent/components/coder/CoSTEER/evolvable_subjects.py#L6-L32)
- [rdagent/core/evolving_framework.py](file://rdagent/core/evolving_framework.py#L40-L127)

## 数据科学场景的具体实现

### DataScienceScen类

DataScienceScen是数据科学领域的具体场景实现，提供了丰富的功能特性：

```mermaid
flowchart TD
A[DataScienceScen初始化] --> B[检查运行环境]
B --> C[准备数据集]
C --> D[收集竞赛信息]
D --> E[分析描述信息]
E --> F[设置超时参数]
F --> G[生成背景描述]
G --> H[返回完整场景]
```

**图表来源**
- [rdagent/scenarios/data_science/scen/__init__.py](file://rdagent/scenarios/data_science/scen/__init__.py#L18-L80)

### 关键功能特性

DataScienceScen提供了以下核心功能：

| 功能 | 方法 | 描述 |
|------|------|------|
| **数据准备** | `_get_data_folder_description()` | 自动分析数据集结构 |
| **竞赛分析** | `_analysis_competition_description()` | 使用LLM分析竞赛要求 |
| **超时管理** | `real_debug_timeout()`, `real_full_timeout()` | 动态调整超时设置 |
| **环境配置** | `get_runtime_environment()` | 获取运行时环境信息 |
| **描述生成** | `get_scenario_all_desc()` | 生成完整的场景描述 |

### KaggleScen扩展

KaggleScen继承自DataScienceScen，专门针对Kaggle竞赛场景进行了优化：

```mermaid
classDiagram
class DataScienceScen {
+competition : str
+metric_name : str
+task_type : str
+data_type : str
+metric_direction : bool
+timeout_increase_count : int
+real_debug_timeout() int
+real_full_timeout() int
+increase_timeout() void
}
class KaggleScen {
+competition : str
+competition_descriptions : str
+input_shape : tuple
+competition_type : str
+leaderboard : list
+vector_base : KaggleExperienceBase
+action_counts : dict
+reward_estimates : dict
+_get_description() str
+_get_direction() bool
}
DataScienceScen <|-- KaggleScen
```

**图表来源**
- [rdagent/scenarios/data_science/scen/__init__.py](file://rdagent/scenarios/data_science/scen/__init__.py#L280-L289)
- [rdagent/scenarios/kaggle/experiment/scenario.py](file://rdagent/scenarios/kaggle/experiment/scenario.py#L25-L100)

**章节来源**
- [rdagent/scenarios/data_science/scen/__init__.py](file://rdagent/scenarios/data_science/scen/__init__.py#L18-L289)
- [rdagent/scenarios/kaggle/experiment/scenario.py](file://rdagent/scenarios/kaggle/experiment/scenario.py#L25-L281)

## 组件协作关系

### CoSTEER架构

RD-Agent采用CoSTEER（Collaborative Software Teamwork for Experimental Research）架构，将不同的研发任务分解为独立的组件：

```mermaid
graph TB
subgraph "数据科学研发循环"
A[DataScienceRDLoop] --> B[ExpGen]
B --> C[Interactor]
C --> D[Coding阶段]
D --> E[Running阶段]
E --> F[Feedback阶段]
F --> G[Record阶段]
end
subgraph "编码组件"
D --> H[DataLoaderCoSTEER]
D --> I[FeatureCoSTEER]
D --> J[ModelCoSTEER]
D --> K[EnsembleCoSTEER]
D --> L[WorkflowCoSTEER]
D --> M[PipelineCoSTEER]
end
subgraph "运行组件"
E --> N[DSCoSTEERRunner]
end
subgraph "反馈组件"
F --> O[DSExperiment2Feedback]
end
```

**图表来源**
- [rdagent/scenarios/data_science/loop.py](file://rdagent/scenarios/data_science/loop.py#L80-L120)

### 组件交互流程

各个组件之间的协作遵循以下流程：

```mermaid
sequenceDiagram
participant RL as RDLoop
participant EG as ExpGen
participant IC as Interactor
participant CD as Coder
participant RN as Runner
participant FB as Feedback
RL->>EG : 生成实验计划
EG-->>RL : 返回实验对象
RL->>IC : 用户交互确认
IC-->>RL : 返回确认的实验
RL->>CD : 执行编码任务
CD-->>RL : 返回编码结果
RL->>RN : 运行实验代码
RN-->>RL : 返回运行结果
RL->>FB : 生成反馈意见
FB-->>RL : 返回反馈结果
```

**图表来源**
- [rdagent/scenarios/data_science/loop.py](file://rdagent/scenarios/data_science/loop.py#L140-L210)

### 超时和资源管理

每个组件都具备智能的资源管理能力：

| 组件 | 资源管理 | 超时策略 |
|------|----------|----------|
| **Coder** | `real_debug_timeout()` | 基于任务复杂度动态调整 |
| **Runner** | `real_full_timeout()` | 基于剩余时间和历史表现 |
| **整体循环** | `increase_timeout()` | 失败时自动增加超时时间 |

**章节来源**
- [rdagent/scenarios/data_science/loop.py](file://rdagent/scenarios/data_science/loop.py#L80-L383)
- [rdagent/components/coder/data_science/share/ds_costeer.py](file://rdagent/components/coder/data_science/share/ds_costeer.py#L1-L9)

## 完整的执行流程

### 数据科学研发循环

数据科学场景的完整执行流程展示了场景与实验的协同工作机制：

```mermaid
flowchart TD
A[初始化RDLoop] --> B[加载场景配置]
B --> C[创建实验生成器]
C --> D[直接实验生成]
D --> E[用户交互确认]
E --> F[编码阶段]
F --> G{实验就绪?}
G --> |否| H[跳过运行]
G --> |是| I[运行实验]
I --> J[生成反馈]
J --> K[记录结果]
K --> L{是否继续?}
L --> |是| D
L --> |否| M[结束循环]
subgraph "编码阶段详细"
F --> F1[数据加载器编码]
F1 --> F2[特征工程编码]
F2 --> F3[模型编码]
F3 --> F4[集成编码]
F4 --> F5[工作流编码]
F5 --> F6[管道编码]
end
```

**图表来源**
- [rdagent/scenarios/data_science/loop.py](file://rdagent/scenarios/data_science/loop.py#L140-L210)

### 实验生命周期管理

实验在整个生命周期中经历多个状态转换：

```mermaid
stateDiagram-v2
[*] --> 初始化
初始化 --> 待编码 : 设置子任务
待编码 --> 编码中 : 开始编码
编码中 --> 编码完成 : 编码成功
编码中 --> 编码失败 : 编码错误
编码完成 --> 待运行 : 准备就绪
待运行 --> 运行中 : 开始执行
运行中 --> 运行完成 : 执行成功
运行中 --> 运行失败 : 执行错误
运行完成 --> 待反馈 : 生成结果
待反馈 --> 反馈完成 : 生成反馈
反馈完成 --> [*] : 结束实验
编码失败 --> 待编码 : 重试或回退
运行失败 --> 待编码 : 错误处理
```

### 演化过程

通过演化Agent，实验可以进行自我改进：

```mermaid
sequenceDiagram
participant EA as EvolvingAgent
participant KB as 知识库
participant ES as 演化策略
participant EI as 演化项目
participant EV as 评估器
loop 演化循环
EA->>KB : 查询相关知识
KB-->>EA : 返回知识片段
EA->>ES : 应用演化策略
ES->>EI : 生成新版本实验
EI-->>ES : 返回演化结果
ES-->>EA : 返回演化项目
EA->>EV : 评估新实验
EV-->>EA : 返回评估结果
EA->>KB : 更新知识库
end
```

**图表来源**
- [rdagent/core/evolving_agent.py](file://rdagent/core/evolving_agent.py#L50-L115)

**章节来源**
- [rdagent/scenarios/data_science/loop.py](file://rdagent/scenarios/data_science/loop.py#L140-L383)
- [rdagent/core/evolving_agent.py](file://rdagent/core/evolving_agent.py#L50-L115)

## 总结

RD-Agent中的场景（Scenario）和实验（Experiment）概念构成了一个完整的研究开发框架。场景定义了应用边界和领域规范，实验封装了具体的研发任务和执行过程，而EvolvingItem则为实验添加了自我演化的能力。

这种设计带来了以下优势：

1. **模块化架构**：场景和实验的分离使得系统具有良好的可扩展性
2. **领域适配**：通过继承Scenario基类，可以轻松适配不同的研究领域
3. **自动化程度高**：CoSTEER架构实现了从任务生成到结果反馈的全自动化流程
4. **智能资源管理**：动态超时调整和资源分配提高了系统效率
5. **演化能力**：通过演化框架，实验可以不断自我改进和优化

通过这种分层设计，RD-Agent不仅能够处理复杂的研发任务，还能够适应不断变化的需求，为人工智能驱动的研究开发提供了强大的基础设施。