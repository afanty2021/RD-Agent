# 知识管理系统

<cite>
**本文档引用的文件**
- [knowledge_base.py](file://rdagent/core/knowledge_base.py)
- [graph.py](file://rdagent/components/knowledge_management/graph.py)
- [vector_base.py](file://rdagent/components/knowledge_management/vector_base.py)
- [extract_knowledge.py](file://rdagent/scenarios/kaggle/knowledge_management/extract_knowledge.py)
- [kaggle_graph.py](file://rdagent/scenarios/kaggle/knowledge_management/graph.py)
- [kaggle_vector_base.py](file://rdagent/scenarios/kaggle/knowledge_management/vector_base.py)
- [costeer_knowledge_management.py](file://rdagent/components/coder/CoSTEER/knowledge_management.py)
- [idea_pool.py](file://rdagent/scenarios/data_science/proposal/exp_gen/idea_pool.py)
- [prompts.yaml](file://rdagent/scenarios/kaggle/knowledge_management/prompts.yaml)
- [llm_utils.py](file://rdagent/oai/llm_utils.py)
</cite>

## 目录
1. [引言](#引言)
2. [系统架构概览](#系统架构概览)
3. [核心组件分析](#核心组件分析)
4. [知识存储机制](#知识存储机制)
5. [知识检索与查询](#知识检索与查询)
6. [知识提取与构建](#知识提取与构建)
7. [知识一致性与版本控制](#知识一致性与版本控制)
8. [扩展指南](#扩展指南)
9. [总结](#总结)

## 引言

RD-Agent的知识管理系统是一个复杂而精密的架构，旨在跨实验积累和利用历史经验。该系统通过结合图数据库（Graph）和向量数据库（VectorBase）两种存储方式，实现了知识的智能存储、检索和更新机制。系统能够处理实验、假设、代码片段等多种类型的知识，并通过语义相似性搜索支持新提案的生成。

## 系统架构概览

RD-Agent的知识管理系统采用分层架构设计，包含核心知识基类、多种知识存储实现和专门的应用场景模块。

```mermaid
graph TB
subgraph "核心层"
KB[KnowledgeBase 核心基类]
KMD[KnowledgeMetaData 元数据]
end
subgraph "存储层"
VB[VectorBase 向量数据库]
GB[Graph 图数据库]
PVB[PDVectorBase Pandas实现]
UG[UndirectedGraph 无向图]
end
subgraph "应用层"
KEG[Kaggle知识图谱]
CKG[CoSTEER知识库]
IDP[IDEA池]
KE[知识提取器]
end
subgraph "工具层"
EMB[嵌入向量生成]
SIM[相似性计算]
PROMPT[提示模板]
end
KB --> VB
KB --> GB
VB --> PVB
GB --> UG
KEG --> UG
CKG --> UG
IDP --> UG
KE --> VB
EMB --> SIM
PROMPT --> KE
```

**图表来源**
- [knowledge_base.py](file://rdagent/core/knowledge_base.py#L1-L28)
- [vector_base.py](file://rdagent/components/knowledge_management/vector_base.py#L1-L50)
- [graph.py](file://rdagent/components/knowledge_management/graph.py#L1-L50)

**章节来源**
- [knowledge_base.py](file://rdagent/core/knowledge_base.py#L1-L28)
- [vector_base.py](file://rdagent/components/knowledge_management/vector_base.py#L1-L209)
- [graph.py](file://rdagent/components/knowledge_management/graph.py#L1-L498)

## 核心组件分析

### KnowledgeBase 基础类

KnowledgeBase是整个知识管理系统的基础抽象类，提供了知识持久化的基本功能。

```mermaid
classDiagram
class KnowledgeBase {
+Path path
+__init__(path : str|Path|None)
+load() void
+dump() void
}
class KnowledgeMetaData {
+str id
+str content
+str label
+Any embedding
+List trunks
+List trunks_embedding
+__init__(content, label, embedding, identity)
+create_embedding() void
+split_into_trunk(size, overlap) void
+from_dict(data) Self
}
class VectorBase {
+add(document) void
+search(content, topk_k, similarity_threshold) List[Document]
}
class PDVectorBase {
+DataFrame vector_df
+__init__(path)
+add(document) void
+search(content, topk_k, similarity_threshold) Tuple
+shape() Tuple
}
KnowledgeBase <|-- VectorBase
VectorBase <|-- PDVectorBase
KnowledgeMetaData <|-- Document
```

**图表来源**
- [knowledge_base.py](file://rdagent/core/knowledge_base.py#L8-L28)
- [vector_base.py](file://rdagent/components/knowledge_management/vector_base.py#L10-L83)

### 图数据库实现

图数据库通过UndirectedGraph类实现，支持节点间的双向连接和复杂的图遍历算法。

```mermaid
classDiagram
class Graph {
+Dict nodes
+__init__(path)
+size() int
+get_node(node_id) Node
+add_node(**kwargs) NoReturn
+get_all_nodes() List[Node]
+find_node(content, label) Node
+batch_embedding(nodes) List[Node]
}
class UndirectedGraph {
+VectorBase vector_base
+__init__(path)
+add_node(node, neighbor, same_node_threshold) void
+add_nodes(node, neighbors) void
+get_node_by_content(content) UndirectedNode
+get_nodes_within_steps(start_node, steps, constraint_labels) List[UndirectedNode]
+semantic_search(node, similarity_threshold, topk_k, constraint_labels) List[UndirectedNode]
+query_by_node(node, step, constraint_labels, constraint_node, block) List[UndirectedNode]
+query_by_content(content, topk_k, step, constraint_labels) List[UndirectedNode]
}
class UndirectedNode {
+Set neighbors
+Any appendix
+__init__(content, label, embedding, appendix)
+add_neighbor(node) void
+remove_neighbor(node) void
+get_neighbors() Set[UndirectedNode]
}
Graph <|-- UndirectedGraph
UndirectedGraph --> UndirectedNode : manages
UndirectedNode --> UndirectedNode : connects
```

**图表来源**
- [graph.py](file://rdagent/components/knowledge_management/graph.py#L40-L150)
- [graph.py](file://rdagent/components/knowledge_management/graph.py#L150-L300)

**章节来源**
- [graph.py](file://rdagent/components/knowledge_management/graph.py#L40-L498)
- [vector_base.py](file://rdagent/components/knowledge_management/vector_base.py#L1-L209)

## 知识存储机制

### 向量数据库存储

向量数据库采用Pandas DataFrame作为底层存储，支持高效的向量相似性搜索。

#### 存储结构设计

| 字段名 | 类型 | 描述 | 必需性 |
|--------|------|------|--------|
| id | str | 文档唯一标识符 | 必需 |
| label | str | 文档标签分类 | 必需 |
| content | str | 文档原始内容 | 必需 |
| trunk | str | 分块后的文本内容 | 可选 |
| embedding | ndarray | 向量嵌入表示 | 必需 |

#### 嵌入生成流程

```mermaid
flowchart TD
Start([开始添加文档]) --> CheckEmbedding{是否已有嵌入?}
CheckEmbedding --> |否| CreateEmbedding[创建向量嵌入]
CheckEmbedding --> |是| SkipEmbedding[跳过嵌入]
CreateEmbedding --> SplitTrunk[分割为文本块]
SplitTrunk --> BatchProcess[批量处理嵌入]
BatchProcess --> StoreDF[存储到DataFrame]
SkipEmbedding --> StoreDF
StoreDF --> AddChunks[添加文本块记录]
AddChunks --> End([完成])
```

**图表来源**
- [vector_base.py](file://rdagent/components/knowledge_management/vector_base.py#L110-L150)

### 图数据库存储

图数据库通过节点和边的关系网络存储知识，支持复杂的语义关联。

#### 节点类型定义

| 节点类型 | 标签 | 用途 | 示例 |
|----------|------|------|------|
| 实验节点 | "experiment" | 记录具体实验 | "XGBoost参数调优" |
| 假设节点 | "hypothesis" | 表达研究假设 | "特征工程改进" |
| 代码节点 | "code" | 存储代码片段 | "数据预处理脚本" |
| 结论节点 | "conclusion" | 总结实验结果 | "模型性能提升" |
| 竞赛节点 | "competition" | 关联竞赛信息 | "Kaggle房价预测" |

#### 边关系定义

```mermaid
graph LR
A[竞赛节点] ---|关联| B[实验节点]
B ---|验证| C[假设节点]
B ---|包含| D[代码节点]
B ---|产生| E[结论节点]
C ---|支持| F[实验节点]
D ---|实现| G[代码片段]
E ---|总结| H[最终结论]
```

**图表来源**
- [kaggle_graph.py](file://rdagent/scenarios/kaggle/knowledge_management/graph.py#L60-L100)

**章节来源**
- [vector_base.py](file://rdagent/components/knowledge_management/vector_base.py#L110-L209)
- [graph.py](file://rdagent/components/knowledge_management/graph.py#L150-L300)

## 知识检索与查询

### 向量相似性搜索

系统使用余弦相似度进行语义相似性搜索，支持多种查询策略。

#### 搜索算法流程

```mermaid
flowchart TD
Query[输入查询内容] --> EmbedQuery[生成查询嵌入]
EmbedQuery --> FilterByLabel{按标签过滤?}
FilterByLabel --> |是| ApplyFilter[应用标签过滤]
FilterByLabel --> |否| ComputeSimilarity[计算余弦相似度]
ApplyFilter --> ComputeSimilarity
ComputeSimilarity --> Threshold{超过阈值?}
Threshold --> |是| SelectTopK[选择Top-K结果]
Threshold --> |否| FilterOut[过滤掉低相似度]
SelectTopK --> SortResults[按相似度排序]
FilterOut --> SortResults
SortResults --> ReturnResults[返回结果列表]
```

**图表来源**
- [vector_base.py](file://rdagent/components/knowledge_management/vector_base.py#L166-L207)

### 图遍历查询

图数据库支持基于语义距离的多步查询和交集查询。

#### 查询策略对比

| 查询类型 | 适用场景 | 时间复杂度 | 特点 |
|----------|----------|------------|------|
| 单步查询 | 直接关联查找 | O(1) | 快速定位直接相关知识 |
| 多步查询 | 探索间接关联 | O(V+E) | 发现潜在的知识联系 |
| 交集查询 | 寻找共同特征 | O(min(V₁,V₂)) | 找到多个条件的共同解 |
| 语义搜索 | 相似内容查找 | O(N×D) | 基于向量相似度匹配 |

#### 高级查询功能

```mermaid
sequenceDiagram
participant User as 用户
participant System as 知识系统
participant Graph as 图数据库
participant Vector as 向量数据库
User->>System : 提交查询请求
System->>Vector : 语义相似性搜索
Vector-->>System : 返回相似文档
System->>Graph : 图遍历查询
Graph-->>System : 返回相关节点
System->>System : 结果融合与排序
System-->>User : 返回综合查询结果
```

**图表来源**
- [graph.py](file://rdagent/components/knowledge_management/graph.py#L300-L400)

**章节来源**
- [vector_base.py](file://rdagent/components/knowledge_management/vector_base.py#L166-L209)
- [graph.py](file://rdagent/components/knowledge_management/graph.py#L300-L498)

## 知识提取与构建

### Kaggle竞赛知识提取

系统通过LLM自动从高分竞赛笔记中提取结构化知识。

#### 知识提取流程

```mermaid
flowchart TD
Input[竞赛笔记输入] --> ParseContent[解析内容结构]
ParseContent --> ExtractMeta[提取元数据]
ExtractMeta --> ClassifyTask[任务类型分类]
ClassifyTask --> ExtractTech[提取技术要点]
ExtractTech --> GenerateJSON[生成JSON格式]
GenerateJSON --> ValidateFormat[验证格式正确性]
ValidateFormat --> StoreKnowledge[存储到知识库]
StoreKnowledge --> BuildGraph[构建知识图谱]
```

**图表来源**
- [extract_knowledge.py](file://rdagent/scenarios/kaggle/knowledge_management/extract_knowledge.py#L10-L30)

#### 提取模板结构

系统使用预定义的提示模板从非结构化文本中提取关键信息：

| 提取字段 | 模板类型 | 示例输出 |
|----------|----------|----------|
| 竞赛名称 | 系统提示 | "House Prices: Advanced Regression Techniques" |
| 任务类型 | 系统提示 | "Regression" |
| 技术领域 | 系统提示 | "Feature Engineering" |
| 排名信息 | 用户提示 | "Top 10%" |
| 关键指标 | 用户提示 | "RMSE: 0.1234" |

### CoSTEER知识管理

CoSTEER系统实现了演化的知识管理策略，支持失败追踪和成功知识的累积。

#### 知识生成流程

```mermaid
stateDiagram-v2
[*] --> 新实验
新实验 --> 执行代码
执行代码 --> 获取反馈
获取反馈 --> 分析结果
分析结果 --> 成功? : 最终决策为True
分析结果 --> 失败? : 最终决策为False
成功? --> 更新成功知识
失败? --> 错误分析
更新成功知识 --> 构建知识图谱
错误分析 --> 存储错误记录
存储错误记录 --> 继续迭代
构建知识图谱 --> 继续迭代
继续迭代 --> 新实验
```

**图表来源**
- [costeer_knowledge_management.py](file://rdagent/components/coder/CoSTEER/knowledge_management.py#L280-L320)

**章节来源**
- [extract_knowledge.py](file://rdagent/scenarios/kaggle/knowledge_management/extract_knowledge.py#L1-L65)
- [kaggle_graph.py](file://rdagent/scenarios/kaggle/knowledge_management/graph.py#L1-L116)
- [costeer_knowledge_management.py](file://rdagent/components/coder/CoSTEER/knowledge_management.py#L280-L400)

## 知识一致性与版本控制

### 知识过期管理

系统实现了基于时间戳和使用频率的知识过期机制。

#### 过期策略

```mermaid
flowchart TD
Access[访问知识] --> CheckAge{检查年龄}
CheckAge --> |超过阈值| CheckUsage{检查使用频率}
CheckAge --> |未超时| UpdateAccess[更新访问时间]
CheckUsage --> |低频使用| MarkExpired[标记过期]
CheckUsage --> |高频使用| UpdateAccess
MarkExpired --> RemoveFromIndex[从索引移除]
UpdateAccess --> ReturnKnowledge[返回知识]
RemoveFromIndex --> CleanupResources[清理资源]
CleanupResources --> ReturnKnowledge
```

### 版本控制机制

系统通过以下机制确保知识的一致性：

1. **嵌入向量版本化**：每次知识更新都会重新生成嵌入向量
2. **图结构验证**：定期验证节点间的连接关系
3. **冲突检测**：识别和解决同名知识的冲突
4. **增量更新**：支持知识的增量式更新而非全量替换

#### 一致性保证流程

```mermaid
sequenceDiagram
participant New as 新知识
participant Validator as 一致性验证器
participant Graph as 图数据库
participant Vector as 向量数据库
New->>Validator : 提交知识更新
Validator->>Graph : 检查图结构完整性
Validator->>Vector : 验证嵌入向量一致性
Graph-->>Validator : 图结构状态
Vector-->>Validator : 向量状态
Validator->>Validator : 执行冲突检测
Validator->>New : 返回验证结果
alt 验证通过
New->>Graph : 应用图更新
New->>Vector : 更新向量存储
else 验证失败
New->>New : 修正知识内容
end
```

**章节来源**
- [knowledge_base.py](file://rdagent/core/knowledge_base.py#L15-L28)
- [graph.py](file://rdagent/components/knowledge_management/graph.py#L200-L250)

## 扩展指南

### 自定义知识类型

开发者可以通过继承基础类来扩展新的知识类型：

#### 创建自定义知识类型

```python
# 示例：创建领域特定的知识类型
class DomainSpecificKnowledge(KnowledgeMetaData):
    def __init__(self, content, label, domain, expertise_level):
        super().__init__(content, label)
        self.domain = domain
        self.expertise_level = expertise_level
        self.related_concepts = []
    
    def add_related_concept(self, concept):
        if concept not in self.related_concepts:
            self.related_concepts.append(concept)
```

#### 注册新知识类型

```python
# 在知识库中注册新的知识类型
class ExtendedKnowledgeBase(UndirectedGraph):
    def __init__(self, path=None):
        super().__init__(path)
        self.register_knowledge_type("domain_specific", DomainSpecificKnowledge)
    
    def add_domain_knowledge(self, content, domain, expertise_level):
        knowledge = DomainSpecificKnowledge(
            content=content,
            label="domain_specific",
            domain=domain,
            expertise_level=expertise_level
        )
        self.add_node(knowledge)
```

### 检索策略实现

#### 自定义相似性度量

```python
# 实现自定义的相似性计算方法
def custom_similarity(node1, node2):
    # 结合语义相似性和结构相似性
    semantic_sim = cosine(node1.embedding, node2.embedding)
    structural_sim = calculate_structural_similarity(node1, node2)
    
    # 加权组合
    return 0.7 * semantic_sim + 0.3 * structural_sim
```

#### 多模态检索策略

```python
# 实现多模态知识检索
class MultimodalRetrieval:
    def __init__(self, text_retriever, code_retriever, graph_retriever):
        self.text_retriever = text_retriever
        self.code_retriever = code_retriever
        self.graph_retriever = graph_retriever
    
    def retrieve(self, query, modalities=["text", "code", "graph"], top_k=5):
        results = {}
        
        if "text" in modalities:
            results["text"] = self.text_retriever.search(query, top_k)
        
        if "code" in modalities:
            results["code"] = self.code_retriever.search(query, top_k)
        
        if "graph" in modalities:
            results["graph"] = self.graph_retriever.query_by_content(query, top_k)
        
        return self.fuse_results(results)
```

### 性能优化建议

#### 索引优化

1. **分层索引**：为不同类型的查询建立专门的索引
2. **缓存策略**：缓存频繁查询的结果
3. **批处理**：对大量数据操作使用批处理模式

#### 内存管理

```python
# 实现内存友好的知识加载
class MemoryEfficientKnowledgeBase(UndirectedGraph):
    def __init__(self, path=None, memory_limit_mb=1024):
        super().__init__(path)
        self.memory_limit = memory_limit_mb * 1024 * 1024
        self.loaded_nodes = {}
    
    def load_node(self, node_id):
        if node_id not in self.loaded_nodes:
            node = self.get_node(node_id)
            if self.get_memory_usage() > self.memory_limit:
                self.evict_least_used()
            self.loaded_nodes[node_id] = node
        return self.loaded_nodes[node_id]
```

**章节来源**
- [graph.py](file://rdagent/components/knowledge_management/graph.py#L150-L200)
- [vector_base.py](file://rdagent/components/knowledge_management/vector_base.py#L110-L150)

## 总结

RD-Agent的知识管理系统展现了现代AI系统中知识管理的最佳实践。通过图数据库和向量数据库的有机结合，系统实现了：

1. **多维度知识存储**：支持结构化和非结构化知识的统一管理
2. **智能知识检索**：基于语义相似性的高效查询机制
3. **自动化知识构建**：通过LLM自动提取和组织知识
4. **演化式学习**：持续积累和优化实验经验
5. **灵活的扩展性**：支持自定义知识类型和检索策略

该系统为AI Agent提供了强大的知识基础设施，使其能够在复杂的科学计算和数据分析任务中做出更明智的决策。随着技术的不断发展，这套知识管理系统将继续演进，为更高级的AI应用提供支持。