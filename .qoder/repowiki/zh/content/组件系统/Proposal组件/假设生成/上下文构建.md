# 上下文构建

<cite>
**本文档引用的文件**
- [proposal.py](file://rdagent\scenarios\kaggle\proposal\proposal.py)
- [quant_proposal.py](file://rdagent\scenarios\qlib\proposal\quant_proposal.py)
- [vector_base.py](file://rdagent\scenarios\kaggle\knowledge_management\vector_base.py)
- [graph.py](file://rdagent\scenarios\kaggle\knowledge_management\graph.py)
- [knowledge_management.py](file://rdagent\components\coder\CoSTEER\knowledge_management.py)
- [proposal.py](file://rdagent\scenarios\data_science\proposal\exp_gen\proposal.py)
- [knowledge_base.py](file://rdagent\core\knowledge_base.py)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构概览](#项目结构概览)
3. [核心组件分析](#核心组件分析)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言

假设生成中的上下文构建是RD-Agent系统的核心机制，它负责整合多源信息以生成高质量的假设。本文档深入分析prepare_context方法如何从知识库中检索历史实验反馈、SOTA结果和RAG检索到的相关知识，并将其结构化为LLM可理解的上下文。

上下文构建机制在不同场景（数据科学、qlib）中展现出不同的实现策略，但都遵循统一的设计原则：多源信息融合、智能检索排序和上下文长度控制。

## 项目结构概览

RD-Agent采用模块化架构，支持多种场景的假设生成：

```mermaid
graph TB
subgraph "场景层"
DS[data_science]
QLIB[qlib]
KAGGLE[kaggle]
end
subgraph "知识管理层"
KB[KnowledgeBase]
VEC[VectorBase]
GRAPH[Graph]
end
subgraph "假设生成层"
HG[HypothesisGen]
HC[ContextBuilder]
RAG[RAG系统]
end
DS --> KB
QLIB --> KB
KAGGLE --> KB
KB --> VEC
KB --> GRAPH
HG --> HC
HC --> RAG
```

**图表来源**
- [proposal.py](file://rdagent\scenarios\kaggle\proposal\proposal.py#L1-L50)
- [knowledge_management.py](file://rdagent\components\coder\CoSTEER\knowledge_management.py#L1-L50)

## 核心组件分析

### 知识库系统

知识库系统是上下文构建的基础，提供多维度的知识存储和检索能力：

```mermaid
classDiagram
class KnowledgeBase {
+Path path
+load() void
+dump() void
}
class VectorBase {
+DataFrame vector_df
+search(content, topk_k) List
+add(document) void
+create_embedding() void
}
class KGKnowledgeGraph {
+load_from_documents() void
+analyze_one_document() List
+semantic_search() List
+get_nodes_within_steps() List
}
class KaggleExperienceBase {
+search_experience() List
+add_experience_to_vector_base() void
+refine_with_LLM() str
}
KnowledgeBase <|-- VectorBase
VectorBase <|-- KaggleExperienceBase
KnowledgeBase <|-- KGKnowledgeGraph
```

**图表来源**
- [knowledge_base.py](file://rdagent\core\knowledge_base.py#L1-L28)
- [vector_base.py](file://rdagent\scenarios\kaggle\knowledge_management\vector_base.py#L1-L50)
- [graph.py](file://rdagent\scenarios\kaggle\knowledge_management\graph.py#L1-L50)

**章节来源**
- [knowledge_base.py](file://rdagent\core\knowledge_base.py#L1-L28)
- [vector_base.py](file://rdagent\scenarios\kaggle\knowledge_management\vector_base.py#L1-L100)
- [graph.py](file://rdagent\scenarios\kaggle\knowledge_management\graph.py#L1-L50)

## 架构概览

上下文构建系统采用分层架构，从底层知识存储到高层假设生成：

```mermaid
sequenceDiagram
participant HG as 假设生成器
participant CB as 上下文构建器
participant KB as 知识库
participant RAG as RAG检索系统
participant LLM as 大语言模型
HG->>CB : prepare_context(trace)
CB->>KB : 检索历史实验反馈
KB-->>CB : 返回反馈摘要
CB->>KB : 查询SOTA结果
KB-->>CB : 返回最佳实践
CB->>RAG : 检索相关知识
RAG-->>CB : 返回相关文档
CB->>CB : 结构化上下文
CB-->>HG : 返回上下文字典
HG->>LLM : 使用上下文生成假设
LLM-->>HG : 返回假设结果
```

**图表来源**
- [proposal.py](file://rdagent\scenarios\kaggle\proposal\proposal.py#L249-L288)
- [quant_proposal.py](file://rdagent\scenarios\qlib\proposal\quant_proposal.py#L49-L165)

## 详细组件分析

### Kaggle场景的上下文构建

Kaggle场景的上下文构建通过KGHypothesisGen类实现，其prepare_context方法展示了完整的知识整合流程：

```mermaid
flowchart TD
Start([开始准备上下文]) --> CheckHistory{是否有历史记录?}
CheckHistory --> |是| GetFeedback[获取历史反馈]
CheckHistory --> |否| NoFeedback[设置无反馈状态]
GetFeedback --> CheckUCB{是否使用UCB算法?}
CheckUCB --> |是| ExecuteAction[执行动作选择]
CheckUCB --> |否| SetDefault[设置默认动作]
ExecuteAction --> BuildSpecification[构建假设规范]
SetDefault --> BuildSpecification
BuildSpecification --> GenerateRAG[生成RAG内容]
GenerateRAG --> CheckRAGType{检查RAG类型}
CheckRAGType --> |向量检索| VectorSearch[向量数据库搜索]
CheckRAGType --> |图谱检索| GraphSearch[知识图谱搜索]
CheckRAGType --> |无RAG| NoRAG[返回None]
VectorSearch --> FormatContent[格式化内容]
GraphSearch --> FormatContent
NoRAG --> FormatContent
FormatContent --> CreateContext[创建上下文字典]
NoFeedback --> CreateContext
CreateContext --> End([返回上下文])
```

**图表来源**
- [proposal.py](file://rdagent\scenarios\kaggle\proposal\proposal.py#L249-L288)

#### RAG内容生成机制

generate_RAG_content函数实现了智能的知识检索和整合：

```mermaid
sequenceDiagram
participant GC as generate_RAG_content
participant KB as 知识库
participant VS as 向量搜索
participant GS as 图谱搜索
participant LLM as LLM精炼
GC->>KB : 检查知识库可用性
alt 使用向量RAG
GC->>VS : 搜索经验帖子
VS-->>GC : 返回相似文档
else 使用图谱RAG
GC->>GS : 获取竞争节点
GS-->>GC : 返回相关节点
GC->>GS : 搜索相似节点
GS-->>GC : 返回相似节点列表
end
GC->>LLM : 对结果进行精炼
LLM-->>GC : 返回优化内容
GC-->>GC : 格式化最终内容
```

**图表来源**
- [proposal.py](file://rdagent\scenarios\kaggle\proposal\proposal.py#L57-L181)

**章节来源**
- [proposal.py](file://rdagent\scenarios\kaggle\proposal\proposal.py#L57-L181)

### Qlib场景的上下文构建

Qlib场景的上下文构建更加复杂，支持多种动作选择策略：

```mermaid
flowchart TD
Start([开始Qlib上下文构建]) --> CheckStrategy{检查动作选择策略}
CheckStrategy --> |Bandit| BanditSelect[贝叶斯决策]
CheckStrategy --> |LLM| LLMSelect[LLM决策]
CheckStrategy --> |Random| RandomSelect[随机选择]
BanditSelect --> SetAction[设置动作]
LLMSelect --> GetLLMResponse[获取LLM响应]
GetLLMResponse --> ParseAction[解析动作]
ParseAction --> SetAction
RandomSelect --> SetAction
SetAction --> CheckAction{检查动作类型}
CheckAction --> |Factor| FactorRAG[因子RAG提示]
CheckAction --> |Model| ModelRAG[模型RAG提示]
FactorRAG --> BuildSpecificContext[构建特定上下文]
ModelRAG --> BuildSpecificContext
BuildSpecificContext --> FilterHistory[过滤历史记录]
FilterHistory --> BuildFeedback[构建反馈上下文]
BuildFeedback --> BuildSOTA[构建SOTA上下文]
BuildSOTA --> CreateFinalContext[创建最终上下文]
CreateFinalContext --> End([返回上下文])
```

**图表来源**
- [quant_proposal.py](file://rdagent\scenarios\qlib\proposal\quant_proposal.py#L49-L165)

**章节来源**
- [quant_proposal.py](file://rdagent\scenarios\qlib\proposal\quant_proposal.py#L49-L165)

### 数据科学场景的上下文构建

数据科学场景的上下文构建更加灵活，支持管道式和组件式两种模式：

```mermaid
classDiagram
class DSProposalV2ExpGen {
+identify_scenario_problem() Dict
+identify_feedback_problem() Dict
+hypothesis_gen() Dict
+hypothesis_critique() Dict
+hypothesis_rewrite() Dict
}
class RAGAgent {
+query(problem) str
+system_prompt str
}
class DSHypothesis {
+component COMPONENT
+hypothesis str
+reason str
+problem_name str
+problem_desc str
}
DSProposalV2ExpGen --> RAGAgent : 使用
DSProposalV2ExpGen --> DSHypothesis : 生成
RAGAgent --> DSHypothesis : 提供知识
```

**图表来源**
- [proposal.py](file://rdagent\scenarios\data_science\proposal\exp_gen\proposal.py#L600-L700)

**章节来源**
- [proposal.py](file://rdagent\scenarios\data_science\proposal\exp_gen\proposal.py#L600-L700)

## 依赖关系分析

上下文构建系统的依赖关系展现了清晰的分层架构：

```mermaid
graph TD
subgraph "应用层"
KGH[KGHypothesisGen]
QGH[QlibQuantHypothesisGen]
DSG[DSProposalV2ExpGen]
end
subgraph "知识管理层"
KB[KnowledgeBase]
VEC[VectorBase]
GRP[Graph]
end
subgraph "工具层"
API[APIBackend]
EMB[Embedding]
PROMPT[Templates]
end
KGH --> KB
QGH --> KB
DSG --> KB
KB --> VEC
KB --> GRP
VEC --> EMB
GRP --> EMB
KGH --> API
QGH --> API
DSG --> API
KGH --> PROMPT
QGH --> PROMPT
DSG --> PROMPT
```

**图表来源**
- [proposal.py](file://rdagent\scenarios\kaggle\proposal\proposal.py#L1-L50)
- [knowledge_management.py](file://rdagent\components\coder\CoSTEER\knowledge_management.py#L1-L50)

**章节来源**
- [proposal.py](file://rdagent\scenarios\kaggle\proposal\proposal.py#L1-L50)
- [knowledge_management.py](file://rdagent\components\coder\CoSTEER\knowledge_management.py#L1-L50)

## 性能考虑

### 上下文长度控制

系统实现了多层次的上下文长度控制机制：

1. **令牌限制检查**：自动检测输入文本是否超过模型的最大令牌数
2. **渐进式截断**：当文本过长时，采用编码解码方式进行精确截断
3. **智能压缩**：对中间部分进行隐藏式压缩，保留首尾关键信息

### 检索效率优化

1. **相似度阈值过滤**：只保留高于阈值的相关结果
2. **Top-K限制**：限制返回结果数量，提高响应速度
3. **缓存机制**：对频繁查询的结果进行缓存

### 内存管理

1. **增量加载**：知识库采用增量加载策略，避免内存溢出
2. **懒加载**：按需加载知识库内容
3. **垃圾回收**：定期清理无用的临时对象

## 故障排除指南

### 知识库为空处理

当知识库为空或检索失败时，系统采用以下降级策略：

```mermaid
flowchart TD
Start([知识库检索开始]) --> CheckKB{知识库是否存在?}
CheckKB --> |否| UseFallback[使用降级策略]
CheckKB --> |是| CheckContent{知识库是否有内容?}
CheckContent --> |否| UseFallback
CheckContent --> |是| TrySearch[尝试搜索]
TrySearch --> CheckResults{搜索结果是否为空?}
CheckResults --> |是| UseFallback
CheckResults --> |否| ProcessResults[处理结果]
UseFallback --> GenerateDefault[生成默认上下文]
ProcessResults --> FormatOutput[格式化输出]
GenerateDefault --> FormatOutput
FormatOutput --> End([返回结果])
```

**图表来源**
- [vector_base.py](file://rdagent\scenarios\kaggle\knowledge_management\vector_base.py#L250-L289)

### 异常处理机制

系统实现了完善的异常处理机制：

1. **嵌入失败处理**：当文本过长导致嵌入失败时，自动进行截断重试
2. **网络超时处理**：对API调用设置合理的超时时间
3. **数据格式验证**：严格验证输入数据的格式和完整性

**章节来源**
- [vector_base.py](file://rdagent\scenarios\kaggle\knowledge_management\vector_base.py#L250-L289)

## 结论

RD-Agent的上下文构建机制展现了现代AI系统设计的最佳实践。通过多源信息融合、智能检索排序和严格的性能控制，系统能够为假设生成提供高质量的上下文支持。

主要特点包括：

1. **模块化设计**：清晰的分层架构便于维护和扩展
2. **多模态检索**：同时支持向量和图谱两种检索方式
3. **智能降级**：在资源受限时提供合理的降级策略
4. **性能优化**：多层次的优化措施确保系统高效运行
5. **异常处理**：完善的错误处理机制保证系统稳定性

这种设计不仅满足了当前的需求，也为未来的功能扩展奠定了坚实的基础。