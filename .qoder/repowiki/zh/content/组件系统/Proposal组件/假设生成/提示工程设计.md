# 提示工程设计

<cite>
**本文档中引用的文件**  
- [prompts.yaml](file://rdagent\app\CI\prompts.yaml)
- [conf.py](file://rdagent\app\data_science\conf.py)
- [qlib_rd_loop\prompts.yaml](file://rdagent\app\qlib_rd_loop\prompts.yaml)
- [exp_gen\prompts_v2.yaml](file://rdagent\scenarios\data_science\proposal\exp_gen\prompts_v2.yaml)
- [scen\prompts.yaml](file://rdagent\scenarios\data_science\scen\prompts.yaml)
- [kaggle\prompts.yaml](file://rdagent\scenarios\kaggle\prompts.yaml)
- [pipeline\prompts.yaml](file://rdagent\components\coder\data_science\pipeline\prompts.yaml)
- [core\prompts.py](file://rdagent\core\prompts.py)
</cite>

## 目录
1. [引言](#引言)
2. [提示架构分析](#提示架构分析)
3. [思维链提示设计](#思维链提示设计)
4. [多样性控制策略](#多样性控制策略)
5. [格式约束机制](#格式约束机制)
6. [场景化提示设计](#场景化提示设计)
7. [提示调优最佳实践](#提示调优最佳实践)
8. [常见问题解决方案](#常见问题解决方案)
9. [结论](#结论)

## 引言
本文档全面解析假设生成的提示工程设计，深入分析prompts.yaml中system_prompt和user_prompt的架构。重点阐述思维链（CoT）提示的设计原理及其在引导LLM推理中的作用，解释多样性控制策略（如temperature设置、top-k采样）如何避免假设同质化。详细说明格式约束（如JSON Schema）如何确保输出的结构化，并结合data_science和qlib场景的提示模板，对比不同场景下的提示设计差异。提供提示调优的最佳实践和常见问题解决方案。

## 提示架构分析
提示工程在RD-Agent系统中扮演着核心角色，通过精心设计的system_prompt和user_prompt来引导大型语言模型（LLM）生成高质量的假设和代码。system_prompt定义了模型的角色、任务和行为准则，而user_prompt提供了具体的上下文信息和任务要求。

在data_science场景中，提示系统通过多个层次的模板文件组织，包括scenario_problem、feedback_problem、hypothesis_gen等，形成了一个完整的假设生成和评估流程。这些提示模板通过Jinja2语法实现了动态内容注入，能够根据不同的场景和上下文生成针对性的提示。

**Section sources**
- [exp_gen\prompts_v2.yaml](file://rdagent\scenarios\data_science\proposal\exp_gen\prompts_v2.yaml)
- [scen\prompts.yaml](file://rdagent\scenarios\data_science\scen\prompts.yaml)

## 思维链提示设计
思维链（Chain-of-Thought, CoT）提示是一种有效的技术，通过引导模型逐步推理来提高复杂任务的解决能力。在RD-Agent系统中，CoT提示被广泛应用于假设生成和问题分析过程。

在hypothesis_gen的system_prompt中，通过明确的步骤指导模型进行假设生成：首先理解挑战，然后分析相关实验，最后提出具体的假设。这种分步指导的方式模拟了人类专家的思考过程，确保模型能够系统性地分析问题并提出合理的解决方案。

此外，提示中还包含了详细的评估标准，要求模型从挑战-假设对齐度、预期影响、新颖性、可行性等多个维度对假设进行评分。这种多维度评估机制进一步增强了模型的推理能力，使其能够生成更高质量的假设。

**Section sources**
- [exp_gen\prompts_v2.yaml](file://rdagent\scenarios\data_science\proposal\exp_gen\prompts_v2.yaml)

## 多样性控制策略
为了防止假设生成过程中的同质化问题，RD-Agent系统采用了多种多样性控制策略。其中，temperature参数和采样策略是关键的控制机制。

在trace_scheduler.py中，temperature参数被用于softmax计算，控制着轨迹选择的概率分布。较高的temperature值会产生更均匀的概率分布，增加探索的多样性；而较低的temperature值则会使选择更倾向于高潜力的轨迹，提高利用效率。

系统还通过sibling_hypotheses机制确保并行探索轨迹之间的多样性。在生成新假设时，模型会被明确告知其他兄弟轨迹的假设内容，并被要求生成不同的解决方案。这种显式的多样性约束有效避免了重复探索相同的技术路径。

**Section sources**
- [trace_scheduler.py](file://rdagent\scenarios\data_science\proposal\exp_gen\trace_scheduler.py)
- [exp_gen\prompts_v2.yaml](file://rdagent\scenarios\data_science\proposal\exp_gen\prompts_v2.yaml)

## 格式约束机制
为了确保LLM输出的结构化和可解析性，RD-Agent系统采用了严格的格式约束机制。JSON Schema是最主要的约束方式，要求模型的输出必须符合预定义的JSON结构。

在多个提示模板中，都明确要求"Please response in json format"，并提供了详细的输出格式说明。这种结构化输出不仅便于后续的自动化处理，还能有效减少模型的自由发挥，提高输出的可靠性和一致性。

此外，系统还通过具体的字段定义和数据类型约束，进一步规范了输出内容。例如，在hypothesis_gen中，要求模型必须为每个假设分配一个组件标签，并在多个维度上进行评分，这些都通过JSON格式得到了严格的约束。

**Section sources**
- [exp_gen\prompts_v2.yaml](file://rdagent\scenarios\data_science\proposal\exp_gen\prompts_v2.yaml)
- [kaggle\prompts.yaml](file://rdagent\scenarios\kaggle\prompts.yaml)

## 场景化提示设计
不同应用场景下的提示设计存在显著差异，反映了各自领域的特定需求和挑战。

在data_science场景中，提示设计强调数据驱动和领域知识的结合。system_prompt中明确要求模型从数据集特性和领域知识两个维度识别挑战，并提出相应的假设。这种双重视角确保了生成的解决方案既符合数据规律，又满足领域要求。

而在qlib场景中，提示设计更侧重于金融分析的专业性。hypothesis_generation的system_prompt要求模型基于金融因子和报告内容生成假设，并以JSON格式输出假设和理由。这种设计突出了金融领域的专业特点，确保了生成内容的相关性和专业性。

**Section sources**
- [exp_gen\prompts_v2.yaml](file://rdagent\scenarios\data_science\proposal\exp_gen\prompts_v2.yaml)
- [qlib_rd_loop\prompts.yaml](file://rdagent\app\qlib_rd_loop\prompts.yaml)

## 提示调优最佳实践
基于对提示工程的深入分析，总结出以下调优最佳实践：

1. **明确角色定义**：在system_prompt中清晰定义模型的角色和专业领域，如"world-class data scientist"或"expert in financial analysis"，这有助于模型建立正确的自我认知。

2. **结构化输出要求**：强制要求JSON格式输出，并提供详细的Schema定义，确保输出的可解析性和一致性。

3. **分步指导**：将复杂任务分解为多个步骤，通过分步指导帮助模型完成系统性推理。

4. **多维度评估**：引入多维度评分机制，要求模型从不同角度评估解决方案的质量。

5. **动态上下文注入**：利用模板引擎实现动态内容注入，使提示能够适应不同的场景和上下文。

6. **多样性约束**：通过temperature参数和显式多样性要求，防止解决方案的同质化。

**Section sources**
- [exp_gen\prompts_v2.yaml](file://rdagent\scenarios\data_science\proposal\exp_gen\prompts_v2.yaml)
- [scen\prompts.yaml](file://rdagent\scenarios\data_science\scen\prompts.yaml)

## 常见问题解决方案
在提示工程实践中，常遇到以下问题及其解决方案：

1. **输出格式不一致**：通过严格的JSON Schema约束和格式验证机制解决，确保输出符合预期结构。

2. **假设同质化**：通过调整temperature参数、引入多样性约束和并行探索机制来增加解决方案的多样性。

3. **推理不充分**：通过思维链提示和分步指导，引导模型进行更深入的系统性推理。

4. **上下文丢失**：通过合理的上下文窗口管理和关键信息摘要，确保重要信息不被截断。

5. **领域知识不足**：通过在提示中注入领域专业知识和最佳实践，增强模型的领域理解能力。

**Section sources**
- [exp_gen\prompts_v2.yaml](file://rdagent\scenarios\data_science\proposal\exp_gen\prompts_v2.yaml)
- [pipeline\prompts.yaml](file://rdagent\components\coder\data_science\pipeline\prompts.yaml)

## 结论
提示工程是RD-Agent系统的核心组成部分，通过精心设计的system_prompt和user_prompt，有效引导LLM生成高质量的假设和代码。思维链提示、多样性控制策略和格式约束机制共同构成了一个完整的提示工程框架，确保了系统在不同应用场景下的有效性和可靠性。未来的工作可以进一步优化提示设计，探索更先进的提示工程技术，以提升系统的整体性能。